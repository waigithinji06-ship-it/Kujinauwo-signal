<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DerivSignal Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060c12;--panel:#0c1720;--p2:#101e2c;--bd:#1c3248;
  --ac:#00d4ff;--gn:#00ff88;--rd:#ff3b5c;--yw:#ffd700;--og:#ff8c00;--pu:#b388ff;
  --tx:#eaf4ff;--dm:#7a9cb8;
  --mn:'Share Tech Mono',monospace;--dp:'Barlow Condensed',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{background:var(--bg);color:var(--tx);font-family:var(--dp);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,212,255,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,.02) 1px,transparent 1px);
  background-size:32px 32px;}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;
  border-bottom:2px solid var(--bd);position:sticky;top:0;z-index:200;background:rgba(6,12,18,.99);backdrop-filter:blur(12px);}
.logo{font-family:var(--dp);font-size:22px;font-weight:900;letter-spacing:2px;color:#fff;}
.logo b{color:var(--ac);}
.pill{display:flex;align-items:center;gap:5px;font-family:var(--mn);font-size:10px;padding:5px 12px;border-radius:20px;border:2px solid;transition:all .3s;letter-spacing:1px;}
.pill.live{color:#00ff88;background:rgba(0,255,136,.12);border-color:rgba(0,255,136,.5);}
.pill.connecting{color:#ffd700;background:rgba(255,215,0,.12);border-color:rgba(255,215,0,.5);}
.pill.offline{color:#ff4466;background:rgba(255,59,92,.12);border-color:rgba(255,59,92,.5);}
.ldot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.ldot.live{background:#00ff88;animation:gl 1.4s infinite;}
.ldot.connecting{background:#ffd700;animation:gl .7s infinite;}
.ldot.offline{background:#ff4466;}
@keyframes gl{0%,100%{opacity:1;}50%{opacity:.2;}}
.clk{font-family:var(--mn);font-size:11px;color:var(--dm);}
#banner{font-family:var(--mn);font-size:10px;padding:7px 16px;text-align:center;letter-spacing:1px;}
#banner.live{background:rgba(0,255,136,.07);color:#00ff88;border-bottom:1px solid rgba(0,255,136,.15);}
#banner.connecting{background:rgba(255,215,0,.07);color:#ffd700;border-bottom:1px solid rgba(255,215,0,.15);}
#banner.offline{background:rgba(255,59,92,.07);color:#ff4466;border-bottom:1px solid rgba(255,59,92,.15);}
.tabs{display:flex;overflow-x:auto;background:rgba(6,12,18,.97);border-bottom:2px solid var(--bd);position:sticky;top:43px;z-index:190;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex:0 0 auto;padding:11px 14px;font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;text-align:center;color:var(--dm);border:none;background:transparent;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;}
.tab.on{color:var(--ac);border-bottom-color:var(--ac);}
.tab:hover{color:var(--tx);}
.tc{display:none;position:relative;z-index:1;padding:14px;}
.tc.on{display:block;}
.p{background:var(--panel);border:1px solid var(--bd);border-radius:8px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden;}
.p::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--ac),transparent);}
.p.g::before{background:linear-gradient(90deg,#00ff88,transparent);}
.p.y::before{background:linear-gradient(90deg,#ffd700,transparent);}
.p.o::before{background:linear-gradient(90deg,#ff8c00,transparent);}
.p.pu::before{background:linear-gradient(90deg,#b388ff,transparent);}
.pt{font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--dm);margin-bottom:10px;}
.ig{margin-bottom:8px;}
.iglbl{font-family:var(--mn);font-size:9px;letter-spacing:2px;color:var(--dm);margin-bottom:5px;text-transform:uppercase;}
.irow{display:flex;flex-wrap:wrap;gap:5px;}
.ib{font-family:var(--mn);font-size:10px;padding:6px 11px;background:var(--p2);border:1px solid var(--bd);color:var(--dm);border-radius:5px;cursor:pointer;transition:all .15s;position:relative;}
.ib:hover{border-color:var(--ac);color:var(--tx);}
.ib.on{border-color:var(--ac);color:var(--ac);background:rgba(0,212,255,.1);}
.ib.s1{border-color:rgba(255,140,0,.3);color:rgba(255,140,0,.65);}
.ib.s1.on{border-color:#ff8c00;color:#ff8c00;background:rgba(255,140,0,.1);}
.ib .lv{position:absolute;top:-3px;right:-3px;width:7px;height:7px;border-radius:50%;background:#00ff88;border:1.5px solid var(--bg);display:none;}
.ib.lv-on .lv{display:block;}
.sc{border:1px solid var(--bd);border-radius:8px;padding:16px;margin-bottom:12px;position:relative;overflow:hidden;background:var(--panel);}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.sc.rise::before{background:linear-gradient(90deg,#00ff88,transparent);}
.sc.fall::before{background:linear-gradient(90deg,#ff3b5c,transparent);}
.sc.wait::before{background:linear-gradient(90deg,#ffd700,transparent);}
.scbg{position:absolute;right:10px;top:50%;transform:translateY(-50%);font-family:var(--dp);font-size:100px;font-weight:900;opacity:.05;pointer-events:none;line-height:1;}
.sctop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
.sclbl{font-family:var(--mn);font-size:9px;letter-spacing:2px;color:var(--dm);margin-bottom:2px;}
.sv{font-family:var(--dp);font-size:60px;font-weight:900;line-height:1;}
.sv.rise{color:#00ff88;text-shadow:0 0 20px rgba(0,255,136,.25);}
.sv.fall{color:#ff3b5c;text-shadow:0 0 20px rgba(255,59,92,.25);}
.sv.wait{color:#ffd700;}
.scr{display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex-shrink:0;}
.sl{font-family:var(--mn);font-size:8px;color:var(--dm);text-align:right;letter-spacing:1px;}
.sv2{font-family:var(--dp);font-size:32px;font-weight:900;line-height:1;text-align:right;}
.sdesc{font-family:var(--mn);font-size:10px;color:var(--dm);margin-top:7px;line-height:1.7;}
.cb{margin-top:8px;}
.cbl{display:flex;justify-content:space-between;font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:3px;}
.cbg{height:4px;background:var(--bd);border-radius:2px;overflow:hidden;}
.cbf{height:100%;border-radius:2px;transition:width .5s;}
.erow{display:flex;justify-content:space-between;font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:8px;margin-bottom:3px;}
.er{display:flex;gap:8px;margin-top:8px;align-items:center;}
.dots{display:flex;gap:5px;flex-wrap:wrap;}
.dot{width:20px;height:20px;border-radius:50%;border:1.5px solid #ffd700;background:transparent;transition:all .3s;}
.dot.on{background:#ffd700;box-shadow:0 0 8px #ffd700;}
.mbtn{font-family:var(--mn);font-size:10px;padding:6px 14px;background:transparent;border:1.5px solid #ffd700;color:#ffd700;border-radius:5px;cursor:pointer;white-space:nowrap;letter-spacing:1px;}
.mbtn:disabled{opacity:.3;cursor:default;}
.ir{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid rgba(28,50,72,.6);}
.ir:last-child{border-bottom:none;}
.in{font-family:var(--mn);font-size:10px;color:var(--dm);}
.iv{font-family:var(--mn);font-size:10px;color:var(--tx);}
.is{font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:1px;padding:3px 8px;border-radius:3px;}
.is.buy{background:rgba(0,255,136,.15);color:#00ff88;}
.is.sell{background:rgba(255,59,92,.15);color:#ff3b5c;}
.is.neutral{background:rgba(255,215,0,.15);color:#ffd700;}
canvas{display:block;width:100%;border-radius:4px;}
.sbox{overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 0;scrollbar-width:none;}
.sbox::-webkit-scrollbar{display:none;}
.srow{display:flex;gap:5px;width:max-content;}
.sd{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:5px;font-family:var(--mn);font-size:14px;font-weight:700;flex-shrink:0;}
.sd.lo{background:rgba(0,255,136,.12);color:#00ff88;border:1px solid rgba(0,255,136,.25);}
.sd.hi{background:rgba(255,59,92,.12);color:#ff3b5c;border:1px solid rgba(255,59,92,.25);}
@keyframes pop{0%{transform:scale(1.5);opacity:0;}100%{transform:scale(1);opacity:1;}}
.sd.new{animation:pop .2s ease;}
.dfwrap{display:flex;align-items:flex-end;gap:4px;height:75px;margin-bottom:4px;}
.dfc{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;}
.dfb{width:100%;border-radius:2px 2px 0 0;transition:height .3s;min-height:2px;}
.dfcnt{font-family:var(--mn);font-size:9px;}
.dflbl{display:flex;gap:4px;margin-top:2px;}
.dflbl span{flex:1;text-align:center;font-family:var(--mn);font-size:11px;font-weight:700;}
.dsg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;}
.dsc{background:var(--panel);border:1px solid var(--bd);border-radius:7px;padding:11px;text-align:center;position:relative;overflow:hidden;}
.dsc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.dsc.g::before{background:#00ff88;}.dsc.r::before{background:#ff3b5c;}
.dsc.y::before{background:#ffd700;}.dsc.a::before{background:#00d4ff;}.dsc.pu::before{background:#b388ff;}
.dslbl{font-family:var(--mn);font-size:8px;letter-spacing:2px;color:var(--dm);margin-bottom:3px;text-transform:uppercase;}
.dsv{font-family:var(--dp);font-size:44px;font-weight:900;line-height:1;}
.dsv.g{color:#00ff88;}.dsv.r{color:#ff3b5c;}.dsv.y{color:#ffd700;}.dsv.a{color:#00d4ff;}.dsv.pu{color:#b388ff;}
.scard{background:var(--panel);border:1px solid var(--bd);border-radius:7px;padding:11px 13px;margin-bottom:8px;display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;}
.scard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
.scard.over::before{background:#00ff88;}.scard.under::before{background:#ff3b5c;}
.scard.diff::before{background:#b388ff;}.scard.match::before{background:#00d4ff;}.scard.wait::before{background:#ffd700;}
.scard.top-pick{border-color:rgba(0,212,255,.4);box-shadow:0 0 14px rgba(0,212,255,.1);}
.sinst{font-family:var(--mn);font-size:11px;font-weight:700;min-width:68px;color:var(--tx);}
.sdir{font-family:var(--dp);font-size:20px;font-weight:900;min-width:58px;}
.sdir.over{color:#00ff88;}.sdir.under{color:#ff3b5c;}.sdir.diff{color:#b388ff;}.sdir.match{color:#00d4ff;}.sdir.wait{color:#ffd700;}
.sdg{font-family:var(--dp);font-size:30px;font-weight:900;color:#00d4ff;min-width:28px;}
.sbars{flex:1;min-width:0;}
.sbrow{display:flex;gap:3px;align-items:center;margin-bottom:3px;}
.sblbl{font-family:var(--mn);font-size:8px;color:var(--dm);min-width:28px;}
.sbbg{flex:1;height:5px;background:var(--bd);border-radius:3px;overflow:hidden;}
.sbf{height:100%;border-radius:3px;transition:width .4s;}
.scond{font-family:var(--mn);font-size:8px;color:var(--dm);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sconf{font-family:var(--mn);font-size:9px;color:var(--dm);min-width:36px;text-align:right;flex-shrink:0;}
.srank{position:absolute;top:5px;right:9px;font-family:var(--mn);font-size:8px;color:var(--dm);}
.favbadge{position:absolute;top:5px;right:9px;font-family:var(--mn);font-size:8px;background:rgba(255,215,0,.12);color:#ffd700;border:1px solid rgba(255,215,0,.3);padding:2px 6px;border-radius:3px;}
.livebadge{font-family:var(--mn);font-size:8px;background:rgba(0,255,136,.12);color:#00ff88;border:1px solid rgba(0,255,136,.3);padding:1px 6px;border-radius:3px;display:inline-block;}
.simbadge{font-family:var(--mn);font-size:8px;background:rgba(255,215,0,.1);color:#ffd700;border:1px solid rgba(255,215,0,.2);padding:1px 6px;border-radius:3px;display:inline-block;}
.abtn{display:block;width:100%;padding:14px;background:transparent;border:2px solid var(--ac);color:var(--ac);font-family:var(--dp);font-size:16px;font-weight:700;letter-spacing:4px;text-transform:uppercase;cursor:pointer;border-radius:6px;transition:all .2s;margin-bottom:12px;}
.abtn:hover{background:rgba(0,212,255,.08);}
.abtn.g{border-color:#00ff88;color:#00ff88;}.abtn.g:hover{background:rgba(0,255,136,.08);}
.abtn.o{border-color:#ff8c00;color:#ff8c00;}.abtn.o:hover{background:rgba(255,140,0,.08);}
.abtn.pu{border-color:#b388ff;color:#b388ff;}.abtn.pu:hover{background:rgba(179,136,255,.08);}
.abtn:disabled{opacity:.35;cursor:default;}
.scanning{display:none;text-align:center;font-family:var(--mn);font-size:10px;letter-spacing:3px;padding:7px;animation:blink .7s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.1;}}
.sg2{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px;}
.scell{background:var(--p2);border:1px solid var(--bd);border-radius:6px;padding:10px;}
.slbl{font-family:var(--mn);font-size:8px;letter-spacing:1px;color:var(--dm);margin-bottom:3px;text-transform:uppercase;}
.sval{font-family:var(--dp);font-size:28px;font-weight:900;line-height:1;}
.vb{display:flex;gap:3px;margin-top:6px;}
.vbar{flex:1;height:24px;background:var(--bd);border-radius:3px;transition:all .3s;}
.tsel{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px;}
.tbtn{flex:1;min-width:36px;padding:8px 4px;background:var(--p2);border:1px solid var(--bd);color:var(--dm);font-family:var(--mn);font-size:11px;border-radius:5px;cursor:pointer;text-align:center;transition:all .2s;}
.tbtn:hover{border-color:var(--ac);color:var(--tx);}
.tbtn.on{border-color:var(--ac);color:var(--ac);background:rgba(0,212,255,.1);}
.lw{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.lt{width:100%;border-collapse:collapse;font-family:var(--mn);font-size:10px;min-width:420px;}
.lt th{padding:6px 8px;color:var(--dm);border-bottom:1px solid var(--bd);text-align:left;font-weight:400;font-size:9px;text-transform:uppercase;white-space:nowrap;}
.lt td{padding:7px 8px;border-bottom:1px solid rgba(28,50,72,.4);white-space:nowrap;color:var(--tx);}
.lt tr:last-child td{border-bottom:none;}
.win{color:#00ff88!important;}.loss{color:#ff3b5c!important;}.wt{color:#ffd700!important;}
.two{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.two .p{margin-bottom:0;}
.bestbox{background:linear-gradient(135deg,rgba(0,212,255,.07),rgba(0,255,136,.04));border:2px solid rgba(0,212,255,.3);border-radius:8px;padding:14px;margin-bottom:12px;position:relative;overflow:hidden;}
.bestbox::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--ac),#00ff88);}
.disc{font-family:var(--mn);font-size:9px;color:var(--dm);text-align:center;padding:14px;line-height:1.8;border-top:1px solid var(--bd);margin-top:6px;}
@media(min-width:768px){.tc{padding:20px;}.dsg{grid-template-columns:repeat(4,1fr);}.sg2{grid-template-columns:repeat(4,1fr);}}
</style>
</head>
<body>
<div class="hdr">
  <div class="logo">Deriv<b>Signal</b></div>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="pill connecting" id="connPill"><div class="ldot connecting" id="connDot"></div><span id="connTxt">CONNECTING</span></div>
    <div class="clk" id="clk">--:--:--</div>
  </div>
</div>
<div id="banner" class="connecting">⟳ Connecting to Deriv live data...</div>
<div class="tabs">
  <button class="tab on" onclick="swTab('rf',this)">HIGHER/LOWER</button>
  <button class="tab" onclick="swTab('dg',this)">DIGITS</button>
  <button class="tab" onclick="swTab('bot',this)">⚡ BOT</button>
  <button class="tab" onclick="swTab('dm',this)">DIFFER/MATCH</button>
  <button class="tab" onclick="swTab('eo',this)">EVEN/ODD</button>
  <button class="tab" onclick="swTab('sc',this)">SCANNER</button>
  <button class="tab" onclick="swTab('hist',this)">HISTORY</button>
</div>

<!-- RISE/FALL -->

<div id="tab-rf" class="tc on">
  <div class="p">
    <div class="pt">Instrument</div>
    <div class="ig"><div class="iglbl">Standard</div><div class="irow">
      <button class="ib on" onclick="selRF(this,'R_10')">V10<span class="lv"></span></button>
      <button class="ib" onclick="selRF(this,'R_25')">V25<span class="lv"></span></button>
      <button class="ib" onclick="selRF(this,'R_50')">V50<span class="lv"></span></button>
      <button class="ib" onclick="selRF(this,'R_75')">V75<span class="lv"></span></button>
      <button class="ib" onclick="selRF(this,'R_100')">V100<span class="lv"></span></button>
    </div></div>
    <div class="ig" style="margin-bottom:0"><div class="iglbl" style="color:rgba(255,140,0,.7)">1 Second</div><div class="irow">
      <button class="ib s1" onclick="selRF(this,'1HZ10V')">V10 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selRF(this,'1HZ25V')">V25 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selRF(this,'1HZ50V')">V50 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selRF(this,'1HZ75V')">V75 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selRF(this,'1HZ100V')">V100 1s<span class="lv"></span></button>
    </div></div>
  </div>
  <div class="p">
    <div class="pt">Live Price — <span id="rfLbl" style="color:var(--ac)">V10</span> <span id="rfLiveBadge" style="margin-left:6px"></span> <span id="rf1sBadge" style="display:none;margin-left:5px;font-family:var(--mn);font-size:8px;background:rgba(255,140,0,.12);color:#ff8c00;border:1px solid rgba(255,140,0,.3);padding:2px 6px;border-radius:3px;">⚡1S</span></div>
    <canvas id="rfChart" height="130"></canvas>
    <div style="display:flex;justify-content:space-between;margin-top:6px;">
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">Price:</span>
      <span style="font-family:var(--mn);font-size:11px;color:#00d4ff;font-weight:700" id="rfLast">waiting...</span>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:3px;">
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">Live ticks:</span>
      <span style="font-family:var(--mn);font-size:10px;color:var(--dm)" id="rfTC">0</span>
    </div>
  </div>
  <div class="sc wait" id="rfCard">
    <div class="scbg" id="rfBg">—</div>
    <div class="sctop">
      <div>
        <div class="sclbl">Signal</div>
        <div class="sv wait" id="rfSv">SCAN</div>
        <div class="sdesc" id="rfDesc">Select instrument then press ANALYSE</div>
        <div id="rf1sNote" style="display:none;font-family:var(--mn);font-size:9px;color:#ff8c00;margin-top:5px;">⚡ 1s — recommended 5+ ticks</div>
      </div>
      <div class="scr">
        <div><div class="sl">TICKS</div><div class="sv2" id="rfTicks" style="color:#00d4ff">—</div></div>
        <div><div class="sl">MAX RUNS</div><div class="sv2" id="rfRuns" style="color:#ffd700">—</div></div>
      </div>
    </div>
    <div class="cb"><div class="cbl"><span>CONFIDENCE</span><span id="rfCpct">—</span></div><div class="cbg"><div class="cbf" id="rfCf" style="width:0%"></div></div></div>
    <div id="rfEW" style="display:none;margin-top:8px;"><div class="erow"><span>EXPIRES IN</span><span id="rfEp" style="color:#ffd700">—</span></div><div class="cbg"><div id="rfEf" style="height:100%;border-radius:2px;background:#ffd700;width:100%;transition:width 1s linear;"></div></div></div>
    <div id="rfRW" style="display:none;margin-top:8px;"><div class="er"><div class="dots" id="rfDots"></div><button class="mbtn" id="rfMb" onclick="rfMark()">+ RUN</button></div></div>
  </div>
  <div class="p">
    <div class="pt">Tick Override</div>
    <div class="tsel">
      <button class="tbtn" onclick="setTick(this,1)">1</button><button class="tbtn" onclick="setTick(this,2)">2</button>
      <button class="tbtn" onclick="setTick(this,3)">3</button><button class="tbtn" onclick="setTick(this,5)">5</button>
      <button class="tbtn" onclick="setTick(this,7)">7</button><button class="tbtn" onclick="setTick(this,10)">10</button>
    </div>
  </div>
  <div class="p">
    <div class="pt">Indicators</div>
    <div class="ir"><span class="in">RSI(14)</span><span class="iv" id="rsiV">—</span><span class="is neutral" id="rsiS">WAIT</span></div>
    <div class="ir"><span class="in">MACD</span><span class="iv" id="macdV">—</span><span class="is neutral" id="macdS">WAIT</span></div>
    <div class="ir"><span class="in">BB Width</span><span class="iv" id="bbV">—</span><span class="is neutral" id="bbS">WAIT</span></div>
    <div class="ir"><span class="in">EMA Cross</span><span class="iv" id="emaV">—</span><span class="is neutral" id="emaS">WAIT</span></div>
    <div class="ir"><span class="in">Stochastic</span><span class="iv" id="stoV">—</span><span class="is neutral" id="stoS">WAIT</span></div>
    <div class="ir"><span class="in">Momentum</span><span class="iv" id="momV">—</span><span class="is neutral" id="momS">WAIT</span></div>
  </div>
  <div class="two">
    <div class="p y">
      <div class="pt">Volatility</div>
      <div style="font-family:var(--dp);font-size:32px;font-weight:900;color:#00d4ff" id="volV">—</div>
      <div style="font-family:var(--mn);font-size:9px;color:var(--dm)" id="volL">PRESS ANALYSE</div>
      <div class="vb" id="volB"><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div><div class="vbar"></div></div>
    </div>
    <div class="p">
      <div class="pt">Session</div>
      <div class="sg2" style="grid-template-columns:1fr 1fr;margin-bottom:0;gap:5px;">
        <div class="scell"><div class="slbl">TOTAL</div><div class="sval" id="rfSC" style="font-size:24px">0</div></div>
        <div class="scell"><div class="slbl">WIN%</div><div class="sval" id="rfWR" style="font-size:24px;color:#00ff88">—</div></div>
        <div class="scell"><div class="slbl">RISE</div><div class="sval" id="rfRC" style="font-size:24px;color:#00ff88">0</div></div>
        <div class="scell"><div class="slbl">FALL</div><div class="sval" id="rfFC" style="font-size:24px;color:#ff3b5c">0</div></div>
      </div>
    </div>
  </div>
  <button class="abtn" onclick="runRF()" id="rfBtn">⬡ ANALYSE LIVE MARKET</button>
  <div class="scanning" id="rfScan" style="color:#00d4ff">ANALYSING...</div>
  <div class="p"><div class="pt">Signal Log</div>
    <div class="lw"><table class="lt">
      <thead><tr><th>TIME</th><th>INST</th><th>SIGNAL</th><th>TICKS</th><th>CONF</th><th>RUNS</th><th>PRICE</th></tr></thead>
      <tbody id="rfLog"><tr><td colspan="7" style="text-align:center;color:var(--dm);padding:16px">No signals yet</td></tr></tbody>
    </table></div>
  </div>
  <div class="disc">⚠ Live Deriv data. No tool guarantees win rates. Trade responsibly.</div>
</div>

<!-- DIGITS OVER/UNDER -->

<div id="tab-dg" class="tc">
  <div class="p">
    <div class="pt">Instrument</div>
    <div class="ig"><div class="iglbl">Standard</div><div class="irow">
      <button class="ib" onclick="selD(this,'R_10')">V10<span class="lv"></span></button>
      <button class="ib" onclick="selD(this,'R_25')">V25<span class="lv"></span></button>
      <button class="ib" onclick="selD(this,'R_50')">V50<span class="lv"></span></button>
      <button class="ib on" onclick="selD(this,'R_75')">V75<span class="lv"></span></button>
      <button class="ib" onclick="selD(this,'R_100')">V100<span class="lv"></span></button>
    </div></div>
    <div class="ig" style="margin-bottom:0"><div class="iglbl" style="color:rgba(255,140,0,.7)">1 Second</div><div class="irow">
      <button class="ib s1" onclick="selD(this,'1HZ10V')">V10 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selD(this,'1HZ25V')">V25 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selD(this,'1HZ50V')">V50 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selD(this,'1HZ75V')">V75 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selD(this,'1HZ100V')">V100 1s<span class="lv"></span></button>
    </div></div>
  </div>
  <div class="p g">
    <div class="pt">Live Digit Stream — <span id="dLbl" style="color:#00d4ff">V75</span> <span id="dLiveBadge" style="margin-left:5px"></span> <span id="dSpd" style="float:right;font-family:var(--mn);font-size:9px;color:var(--dm)">waiting...</span></div>
    <div class="sbox"><div class="srow" id="srow"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;">
      <span style="font-family:var(--mn);font-size:9px;"><span style="color:#00ff88">■</span> <span style="color:var(--dm)">Low 0-4</span> &nbsp;&nbsp;<span style="color:#ff3b5c">■</span> <span style="color:var(--dm)">High 5-9</span></span>
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">Last: <span id="dLast" style="color:#00d4ff;font-weight:700">—</span></span>
    </div>
    <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:4px" id="dInfo">Waiting for live data...</div>
  </div>
  <div class="p">
    <div class="pt">Digit Frequency — Live 50 Ticks</div>
    <div class="dfwrap" id="dfChart"></div><div class="dflbl" id="dfLbl"></div>
    <div style="display:flex;gap:8px;margin-top:10px;">
      <div style="flex:1;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.15);border-radius:5px;padding:10px;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-bottom:3px">LOW (0–4)</div>
        <div style="font-family:var(--dp);font-size:24px;font-weight:900;color:#00ff88" id="dLow">—</div>
        <div id="dLT" style="display:flex;gap:3px;flex-wrap:wrap;margin-top:5px"></div>
      </div>
      <div style="flex:1;background:rgba(255,59,92,.06);border:1px solid rgba(255,59,92,.15);border-radius:5px;padding:10px;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-bottom:3px">HIGH (5–9)</div>
        <div style="font-family:var(--dp);font-size:24px;font-weight:900;color:#ff3b5c" id="dHigh">—</div>
        <div id="dHT" style="display:flex;gap:3px;flex-wrap:wrap;margin-top:5px"></div>
      </div>
    </div>
  </div>
  <div class="dsg">
    <div class="dsc y" id="dDirCell"><div class="dslbl">Direction</div><div class="dsv y" id="dDir">—</div></div>
    <div class="dsc a"><div class="dslbl">Entry Digit</div><div class="dsv a" id="dEnt">—</div></div>
    <div class="dsc y"><div class="dslbl">Max Runs</div><div class="dsv y" id="dRns">—</div></div>
    <div class="dsc a"><div class="dslbl">Streak</div><div class="dsv a" id="dStr">—</div></div>
  </div>
  <div class="p">
    <div class="pt">Signal Condition</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--tx);line-height:1.7" id="dCond">Press ANALYSE to generate signal</div>
    <div class="cb" style="margin-top:8px"><div class="cbl"><span>CONFIDENCE</span><span id="dCpct">—</span></div><div class="cbg"><div class="cbf" id="dCf" style="width:0%"></div></div></div>
    <div id="dEW" style="display:none;margin-top:8px"><div class="erow"><span>EXPIRES IN</span><span id="dEp" style="color:#ffd700">—</span></div><div class="cbg"><div id="dEf" style="height:100%;border-radius:2px;background:#ffd700;width:100%;transition:width 1s linear"></div></div></div>
    <div id="dRW" style="display:none;margin-top:8px"><div class="er"><div class="dots" id="dDots"></div><button class="mbtn" id="dMb" onclick="dMark()">+ RUN</button></div><div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:5px" id="dRN"></div></div>
  </div>
  <button class="abtn g" onclick="runD()" id="dBtn">◈ ANALYSE OVER / UNDER</button>
  <div class="scanning" id="dScan" style="color:#00ff88">READING LIVE STREAM...</div>
  <div class="p"><div class="pt">Signal Log</div>
    <div class="lw"><table class="lt">
      <thead><tr><th>TIME</th><th>INST</th><th>DIR</th><th>DIGIT</th><th>COND</th><th>RUNS</th><th>LO%</th><th>HI%</th></tr></thead>
      <tbody id="dLog"><tr><td colspan="8" style="text-align:center;color:var(--dm);padding:16px">No signals yet</td></tr></tbody>
    </table></div>
  </div>
  <div class="disc">⚠ Statistical analysis only.</div>
</div>

<!-- AUTO BOT -->

<div id="tab-bot" class="tc">
  <div class="p" style="border-top:3px solid #ffd700;">
    <div class="pt" style="color:#ffd700;">⚡ AUTO TRADING BOTS</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--dm);line-height:1.8">
      Bot runs isolated — top tracker freezes. One trade at a time. Full history below.<br>
      <b style="color:#ff3b5c">⚠ Places real trades. Set TP/SL carefully.</b>
    </div>
    <!-- Bot Selector -->
    <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;">
      <button id="botSelOU" onclick="selBot('ou')" style="flex:1;padding:8px;background:rgba(0,255,136,.15);border:2px solid #00ff88;color:#00ff88;font-family:var(--dp);font-size:10px;font-weight:700;letter-spacing:1px;border-radius:5px;cursor:pointer;">OVER/UNDER<br><span style="font-size:8px;opacity:.7">O0-2/U7-9 → O3-4/U5-6 ×3.6</span></button>
      <button id="botSelEO" onclick="selBot('eo')" style="flex:1;padding:8px;background:rgba(0,212,255,.08);border:2px solid rgba(0,212,255,.4);color:var(--dm);font-family:var(--dp);font-size:10px;font-weight:700;letter-spacing:1px;border-radius:5px;cursor:pointer;">EVEN/ODD<br><span style="font-size:8px;opacity:.7">MG×2.1</span></button>
      <button id="botSelDF" onclick="selBot('df')" style="flex:1;padding:8px;background:rgba(179,136,255,.08);border:2px solid rgba(179,136,255,.4);color:var(--dm);font-family:var(--dp);font-size:10px;font-weight:700;letter-spacing:1px;border-radius:5px;cursor:pointer;">DIFFERS<br><span style="font-size:8px;opacity:.7">MG×6.8</span></button>
    </div>
  </div>
  <!-- TP/SL Settings -->
  <div class="p y">
    <div class="pt">Take Profit &amp; Stop Loss</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
      <div style="flex:1;min-width:120px;">
        <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:5px;">TAKE PROFIT ($)</div>
        <input id="botTP" type="number" value="20" min="1" step="1"
          style="width:100%;background:var(--p2);border:1.5px solid rgba(0,255,136,.3);color:#00ff88;font-family:var(--dp);font-size:22px;font-weight:900;padding:8px 10px;border-radius:5px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-top:3px;">Bot stops when P&L reaches this</div>
      </div>
      <div style="flex:1;min-width:120px;">
        <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:5px;">STOP LOSS ($)</div>
        <input id="botSL" type="number" value="15" min="1" step="1"
          style="width:100%;background:var(--p2);border:1.5px solid rgba(255,59,92,.3);color:#ff3b5c;font-family:var(--dp);font-size:22px;font-weight:900;padding:8px 10px;border-radius:5px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-top:3px;">Bot stops on this loss</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:120px;">
        <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:5px;">BASE STAKE ($) <span style="color:#00d4ff">— syncs with main MG on start</span></div>
        <input id="botBase" type="number" value="1" min="0.35" step="0.5"
          style="width:100%;background:var(--p2);border:1.5px solid rgba(255,215,0,.3);color:#ffd700;font-family:var(--dp);font-size:22px;font-weight:900;padding:8px 10px;border-radius:5px;text-align:center;"
          onchange="MG.base=parseFloat(this.value)||1;MG.current=MG.base;document.getElementById('stakeAmt').value=MG.base.toFixed(2);updMartStats();">
      </div>
      <div style="flex:1;min-width:120px;">
        <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:5px;">MAX STAKE ($)</div>
        <input id="botMaxStake" type="number" value="30" min="1"
          style="width:100%;background:var(--p2);border:1.5px solid rgba(255,140,0,.3);color:#ff8c00;font-family:var(--dp);font-size:22px;font-weight:900;padding:8px 10px;border-radius:5px;text-align:center;">
      </div>
    </div>
  </div>
  <!-- Bot Stats -->
  <div class="p" id="botStatsPanel">
    <div class="pt">Bot Performance</div>
    <div style="font-family:var(--mn);font-size:8px;color:rgba(0,212,255,.6);margin-bottom:6px;">BOT SESSION ONLY — resets each start. Main MG tracker above is lifetime.</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">BOT P&L</div>
        <div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#00ff88" id="botPnl">$0</div>
      </div>
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">WINS</div>
        <div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#00ff88" id="botWins">0</div>
      </div>
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">LOSSES</div>
        <div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#ff3b5c" id="botLosses">0</div>
      </div>
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">NEXT STAKE</div>
        <div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#ffd700" id="botNextStake">$1</div>
      </div>
    </div>
    <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-bottom:4px;">
      MODE: <span id="botModeLabel" style="color:#00ff88">NORMAL · OVER2/UNDER7</span>
    </div>
    <div style="font-family:var(--mn);font-size:9px;padding:6px 10px;background:rgba(0,0,0,.2);border-radius:4px;" id="botStatus">Bot stopped</div>
  </div>
  <!-- Bot Activity Log -->
  <div class="p" id="botLogPanel">
    <div class="pt">Bot Activity <span style="font-size:8px;color:var(--dm);font-family:var(--mn)">(live log)</span></div>
    <div id="botActivity" style="font-family:var(--mn);font-size:9px;color:var(--dm);max-height:140px;overflow-y:auto;line-height:2;">Bot not started yet.</div>
  </div>
  <!-- Bot Trade History -->
  <div class="p">
    <div class="pt">Bot Trade History</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
      <div style="flex:1;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:7px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">WIN RATE</div>
        <div style="font-family:var(--dp);font-size:20px;font-weight:900" id="botHistWR">—</div>
      </div>
      <div style="flex:1;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:7px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">TRADES</div>
        <div style="font-family:var(--dp);font-size:20px;font-weight:900;color:var(--tx)" id="botHistTotal">0</div>
      </div>
      <div style="flex:1;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:7px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">P&L</div>
        <div style="font-family:var(--dp);font-size:20px;font-weight:900;color:#00ff88" id="botHistPnl">$0</div>
      </div>
    </div>
    <button onclick="exportBotCSV()" style="width:100%;padding:8px;background:rgba(255,215,0,.1);border:1.5px solid rgba(255,215,0,.4);color:#ffd700;font-family:var(--dp);font-size:12px;font-weight:700;letter-spacing:2px;border-radius:5px;cursor:pointer;margin-bottom:8px;">⬇ EXPORT BOT CSV</button>
    <div style="overflow-x:auto;">
      <table class="lt" style="width:100%;min-width:480px;">
        <thead>
          <tr>
            <th>TIME</th><th>MODE</th><th>TYPE</th><th>INST</th>
            <th>STAKE</th><th>P&L</th><th>RES</th><th>CONTRACT ID</th>
          </tr>
        </thead>
        <tbody id="botHistTbl">
          <tr><td colspan="8" style="text-align:center;color:var(--dm);padding:16px">No bot trades yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- Start/Stop -->
  <button id="botStartBtn" onclick="startBot()" class="abtn" style="border-color:#ffd700;color:#ffd700;">⚡ START AUTO BOT</button>
  <button id="botStopBtn" onclick="stopBot()" class="abtn" style="display:none;border-color:#ff3b5c;color:#ff3b5c;">■ STOP BOT</button>
  <div class="disc">⚠ Auto bot places real trades. Set TP/SL carefully. Monitor actively.</div>
</div>

<!-- DIFFER/MATCH -->

<div id="tab-dm" class="tc">
  <div class="p pu">
    <div class="pt">Differs &amp; Matches</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--dm);line-height:1.9">
      <b style="color:#b388ff">DIFFERS</b> — next tick's last digit will differ from predicted digit.<br>
      <b style="color:#00d4ff">MATCHES</b> — next tick's last digit will match the predicted digit.<br>
      Signals based on hot/cold digit patterns from live stream.
    </div>
  </div>
  <div class="p">
    <div class="pt">Instrument</div>
    <div class="ig"><div class="iglbl">Standard</div><div class="irow">
      <button class="ib" onclick="selDM(this,'R_10')">V10<span class="lv"></span></button>
      <button class="ib" onclick="selDM(this,'R_25')">V25<span class="lv"></span></button>
      <button class="ib" onclick="selDM(this,'R_50')">V50<span class="lv"></span></button>
      <button class="ib on" onclick="selDM(this,'R_75')">V75<span class="lv"></span></button>
      <button class="ib" onclick="selDM(this,'R_100')">V100<span class="lv"></span></button>
    </div></div>
    <div class="ig" style="margin-bottom:0"><div class="iglbl" style="color:rgba(255,140,0,.7)">1 Second</div><div class="irow">
      <button class="ib s1" onclick="selDM(this,'1HZ10V')">V10 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selDM(this,'1HZ25V')">V25 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selDM(this,'1HZ50V')">V50 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selDM(this,'1HZ75V')">V75 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selDM(this,'1HZ100V')">V100 1s<span class="lv"></span></button>
    </div></div>
  </div>
  <div class="p g">
    <div class="pt">Live Digit Stream — <span id="dmLbl" style="color:#00d4ff">V75</span> <span id="dmLiveBadge" style="margin-left:5px"></span></div>
    <div class="sbox"><div class="srow" id="dmrow"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;">
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">Last: <span id="dmLast" style="color:#00d4ff;font-weight:700">—</span></span>
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)" id="dmInfo">waiting...</span>
    </div>
  </div>
  <div class="p">
    <div class="pt">Digit Frequency</div>
    <div class="dfwrap" id="dmdfChart"></div><div class="dflbl" id="dmdfLbl"></div>
  </div>
  <div class="dsg">
    <div class="dsc pu" id="dmDirCell"><div class="dslbl">Contract</div><div class="dsv pu" id="dmDir">—</div></div>
    <div class="dsc a"><div class="dslbl">Digit</div><div class="dsv a" id="dmDig">—</div></div>
    <div class="dsc y"><div class="dslbl">Max Runs</div><div class="dsv y" id="dmRns">—</div></div>
    <div class="dsc a"><div class="dslbl">Streak</div><div class="dsv a" id="dmStr">—</div></div>
  </div>
  <div class="p">
    <div class="pt">Signal Condition</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--tx);line-height:1.7" id="dmCond">Press ANALYSE to generate signal</div>
    <div class="cb" style="margin-top:8px"><div class="cbl"><span>CONFIDENCE</span><span id="dmCpct">—</span></div><div class="cbg"><div class="cbf" id="dmCf" style="width:0%"></div></div></div>
    <div id="dmEW" style="display:none;margin-top:8px"><div class="erow"><span>EXPIRES IN</span><span id="dmEp" style="color:#ffd700">—</span></div><div class="cbg"><div id="dmEf" style="height:100%;border-radius:2px;background:#ffd700;width:100%;transition:width 1s linear"></div></div></div>
    <div id="dmRW" style="display:none;margin-top:8px"><div class="er"><div class="dots" id="dmDots"></div><button class="mbtn" id="dmMb" onclick="dmMark()">+ RUN</button></div><div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:5px" id="dmRN"></div></div>
  </div>
  <button class="abtn pu" onclick="runDM()" id="dmBtn">◆ ANALYSE DIFFER / MATCH</button>
  <div class="scanning" id="dmScan" style="color:#b388ff">ANALYSING PATTERNS...</div>
  <div class="p"><div class="pt">Signal Log</div>
    <div class="lw"><table class="lt">
      <thead><tr><th>TIME</th><th>INST</th><th>TYPE</th><th>DIGIT</th><th>REASON</th><th>RUNS</th><th>CONF</th></tr></thead>
      <tbody id="dmLog"><tr><td colspan="7" style="text-align:center;color:var(--dm);padding:16px">No signals yet</td></tr></tbody>
    </table></div>
  </div>
  <div class="disc">⚠ Differs/Matches are ~50/50 probability contracts. Analysis improves edge only slightly.</div>
</div>

<!-- EVEN/ODD -->

<div id="tab-eo" class="tc">
  <div class="p pu">
    <div class="pt">Even &amp; Odd</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--dm);line-height:1.9">
      <b style="color:#00d4ff">EVEN</b> — last digit is even (0,2,4,6,8).<br>
      <b style="color:#b388ff">ODD</b> — last digit is odd (1,3,5,7,9).<br>
      Analysis detects streaks and frequency bias.
    </div>
  </div>
  <div class="p">
    <div class="pt">Instrument</div>
    <div class="ig"><div class="iglbl">Standard</div><div class="irow">
      <button class="ib" onclick="selEO(this,'R_10')">V10<span class="lv"></span></button>
      <button class="ib" onclick="selEO(this,'R_25')">V25<span class="lv"></span></button>
      <button class="ib" onclick="selEO(this,'R_50')">V50<span class="lv"></span></button>
      <button class="ib on" onclick="selEO(this,'R_75')">V75<span class="lv"></span></button>
      <button class="ib" onclick="selEO(this,'R_100')">V100<span class="lv"></span></button>
    </div></div>
    <div class="ig" style="margin-bottom:0"><div class="iglbl" style="color:rgba(255,140,0,.7)">1 Second</div><div class="irow">
      <button class="ib s1" onclick="selEO(this,'1HZ10V')">V10 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selEO(this,'1HZ25V')">V25 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selEO(this,'1HZ50V')">V50 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selEO(this,'1HZ75V')">V75 1s<span class="lv"></span></button>
      <button class="ib s1" onclick="selEO(this,'1HZ100V')">V100 1s<span class="lv"></span></button>
    </div></div>
  </div>
  <div class="p g">
    <div class="pt">Live Stream — <span id="eoLbl" style="color:#00d4ff">V75</span> <span id="eoLiveBadge" style="margin-left:5px"></span></div>
    <div class="sbox"><div class="srow" id="eorow"></div></div>
    <div style="display:flex;justify-content:space-between;margin-top:6px;">
      <span style="font-family:var(--mn);font-size:9px;"><span style="color:#00d4ff">■</span> <span style="color:var(--dm)">Even</span> &nbsp;<span style="color:#b388ff">■</span> <span style="color:var(--dm)">Odd</span></span>
      <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">Last: <span id="eoLast" style="color:#00d4ff;font-weight:700">—</span></span>
    </div>
    <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:4px" id="eoInfo">waiting...</div>
  </div>
  <div class="p">
    <div class="pt">Frequency — Live 50 Ticks</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;">
      <div style="flex:1;background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:5px;padding:12px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">EVEN (0,2,4,6,8)</div>
        <div style="font-family:var(--dp);font-size:32px;font-weight:900;color:#00d4ff" id="eoEvenPct">—</div>
        <div style="height:5px;background:var(--bd);border-radius:3px;overflow:hidden;margin-top:6px"><div id="eoEvenBar" style="height:100%;background:#00d4ff;border-radius:3px;width:50%"></div></div>
      </div>
      <div style="flex:1;background:rgba(179,136,255,.06);border:1px solid rgba(179,136,255,.15);border-radius:5px;padding:12px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">ODD (1,3,5,7,9)</div>
        <div style="font-family:var(--dp);font-size:32px;font-weight:900;color:#b388ff" id="eoOddPct">—</div>
        <div style="height:5px;background:var(--bd);border-radius:3px;overflow:hidden;margin-top:6px"><div id="eoOddBar" style="height:100%;background:#b388ff;border-radius:3px;width:50%"></div></div>
      </div>
    </div>
    <div style="font-family:var(--mn);font-size:9px;color:var(--dm)">Last 10: <span id="eoLast10" style="color:var(--tx);letter-spacing:3px">—</span></div>
    <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:4px">Streak: <span id="eoStreakTxt" style="color:#ffd700">—</span></div>
  </div>
  <div class="dsg" style="grid-template-columns:1fr 1fr">
    <div class="dsc a" id="eoDirCell"><div class="dslbl">Signal</div><div class="dsv a" id="eoDir">—</div></div>
    <div class="dsc y"><div class="dslbl">Max Runs</div><div class="dsv y" id="eoRns">—</div></div>
  </div>
  <div class="p">
    <div class="pt">Signal Condition</div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--tx);line-height:1.7" id="eoCond">Press ANALYSE to generate signal</div>
    <div class="cb" style="margin-top:8px"><div class="cbl"><span>CONFIDENCE</span><span id="eoCpct">—</span></div><div class="cbg"><div class="cbf" id="eoCf" style="width:0%"></div></div></div>
    <div id="eoEW" style="display:none;margin-top:8px"><div class="erow"><span>EXPIRES IN</span><span id="eoEp" style="color:#ffd700">—</span></div><div class="cbg"><div id="eoEf" style="height:100%;border-radius:2px;background:#ffd700;width:100%;transition:width 1s linear"></div></div></div>
    <div id="eoRW" style="display:none;margin-top:8px"><div class="er"><div class="dots" id="eoDots"></div><button class="mbtn" id="eoMb" onclick="eoMark()">+ RUN</button></div><div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-top:5px" id="eoRN"></div></div>
  </div>
  <button class="abtn" style="border-color:#00d4ff;color:#00d4ff;" onclick="runEO()" id="eoBtn">◉ ANALYSE EVEN / ODD</button>
  <div class="scanning" id="eoScan" style="color:#00d4ff">ANALYSING...</div>
  <div class="trade-btn-wrap" style="display:none;margin-bottom:12px;">
    <button onclick="tradeEO()" style="width:100%;padding:13px;background:rgba(0,212,255,.1);border:2px solid #00d4ff;color:#00d4ff;font-family:var(--dp);font-size:16px;font-weight:900;letter-spacing:3px;border-radius:6px;cursor:pointer;">⚡ PLACE EVEN/ODD · ALL RUNS</button>
  </div>
  <div class="p"><div class="pt">Signal Log</div>
    <div class="lw"><table class="lt">
      <thead><tr><th>TIME</th><th>INST</th><th>TYPE</th><th>EVEN%</th><th>ODD%</th><th>RUNS</th><th>CONF</th></tr></thead>
      <tbody id="eoLog"><tr><td colspan="7" style="text-align:center;color:var(--dm);padding:16px">No signals yet</td></tr></tbody>
    </table></div>
  </div>
  <div class="disc">⚠ Even/Odd ~50/50. Analysis improves edge marginally.</div>
</div>

<!-- HISTORY TAB -->

<div id="tab-hist" class="tc">
  <div class="p" style="border-top:2px solid #ffd700;">
    <div class="pt" style="color:#ffd700;">Trade History</div>
    <!-- Summary stats -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">WIN RATE</div>
        <div style="font-family:var(--dp);font-size:24px;font-weight:900;color:#00ff88" id="histWR">—</div>
      </div>
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">TOTAL TRADES</div>
        <div style="font-family:var(--dp);font-size:24px;font-weight:900;color:var(--tx)" id="histTotal">0</div>
      </div>
      <div style="flex:1;min-width:70px;background:var(--p2);border:1px solid var(--bd);border-radius:5px;padding:8px;text-align:center;">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">SESSION P&L</div>
        <div style="font-family:var(--dp);font-size:24px;font-weight:900;color:#00ff88" id="histPnl">$0</div>
      </div>
    </div>
    <!-- Export button -->
    <button onclick="exportCSV()" style="width:100%;padding:10px;background:rgba(255,215,0,.1);border:1.5px solid rgba(255,215,0,.4);color:#ffd700;font-family:var(--dp);font-size:13px;font-weight:700;letter-spacing:2px;border-radius:5px;cursor:pointer;margin-bottom:10px;">⬇ EXPORT CSV</button>
    <!-- Table -->
    <div style="overflow-x:auto;">
      <table class="lt" style="width:100%">
        <thead>
          <tr>
            <th>TIME</th><th>TYPE</th><th>INST</th><th>DIG</th><th>STAKE</th><th>P&L</th><th>RESULT</th>
          </tr>
        </thead>
        <tbody id="tradeHistTbl">
          <tr><td colspan="7" style="text-align:center;color:var(--dm);padding:20px;">No trades yet this session</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="disc">History resets on page refresh. Export CSV to save permanently.</div>
</div>

<!-- SCANNER -->

<div id="tab-sc" class="tc">
  <div class="p o">
    <div class="pt">Auto Scanner <span style="font-family:var(--mn);font-size:8px;background:rgba(255,140,0,.12);color:#ff8c00;border:1px solid rgba(255,140,0,.25);padding:2px 7px;border-radius:3px;margin-left:6px;vertical-align:middle;">⟳ AUTO 30s</span></div>
    <div style="font-family:var(--mn);font-size:10px;color:var(--dm);line-height:1.8">Scans all 10 markets. Auto-refreshes every 30s. Over/Under + Differs/Matches ranked by confidence.</div>
  </div>
  <div class="bestbox" id="bestPanel" style="display:none">
    <div style="font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:3px;color:#00d4ff;margin-bottom:10px;">🏆 BEST LIVE OPPORTUNITY</div>
    <div id="bestContent"></div>
  </div>
  <div class="p g">
    <div class="pt">Your Favourites</div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:10px">
      <div style="background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);border-radius:5px;padding:8px 12px;text-align:center;min-width:60px">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">OVER</div>
        <div style="font-family:var(--dp);font-size:28px;font-weight:900;color:#00ff88" id="fovD">2</div>
      </div>
      <div style="background:rgba(255,59,92,.08);border:1px solid rgba(255,59,92,.2);border-radius:5px;padding:8px 12px;text-align:center;min-width:60px">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">UNDER</div>
        <div style="font-family:var(--dp);font-size:28px;font-weight:900;color:#ff3b5c" id="fundD">7</div>
      </div>
      <div style="background:rgba(179,136,255,.08);border:1px solid rgba(179,136,255,.2);border-radius:5px;padding:8px 12px;text-align:center;min-width:60px">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">DIFFERS</div>
        <div style="font-family:var(--dp);font-size:28px;font-weight:900;color:#b388ff" id="fdifD">5</div>
      </div>
      <div style="background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);border-radius:5px;padding:8px 12px;text-align:center;min-width:60px">
        <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">MATCHES</div>
        <div style="font-family:var(--dp);font-size:28px;font-weight:900;color:#00d4ff" id="fmatD">5</div>
      </div>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap">
      <select id="fovS" onchange="updFavs()" style="flex:1;min-width:100px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:10px;padding:7px;border-radius:5px">
        <option value="0">Over 0</option><option value="1">Over 1</option><option value="2" selected>Over 2</option><option value="3">Over 3</option><option value="4">Over 4</option>
      </select>
      <select id="fundS" onchange="updFavs()" style="flex:1;min-width:100px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:10px;padding:7px;border-radius:5px">
        <option value="5">Under 5</option><option value="6">Under 6</option><option value="7" selected>Under 7</option><option value="8">Under 8</option><option value="9">Under 9</option>
      </select>
      <select id="fdifS" onchange="updFavs()" style="flex:1;min-width:100px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:10px;padding:7px;border-radius:5px">
        <option value="0">Differs 0</option><option value="1">Differs 1</option><option value="2">Differs 2</option><option value="3">Differs 3</option><option value="4">Differs 4</option>
        <option value="5" selected>Differs 5</option><option value="6">Differs 6</option><option value="7">Differs 7</option><option value="8">Differs 8</option><option value="9">Differs 9</option>
      </select>
      <select id="fmatS" onchange="updFavs()" style="flex:1;min-width:100px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:10px;padding:7px;border-radius:5px">
        <option value="0">Matches 0</option><option value="1">Matches 1</option><option value="2">Matches 2</option><option value="3">Matches 3</option><option value="4">Matches 4</option>
        <option value="5" selected>Matches 5</option><option value="6">Matches 6</option><option value="7">Matches 7</option><option value="8">Matches 8</option><option value="9">Matches 9</option>
      </select>
    </div>
  </div>
  <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center;flex-wrap:wrap;">
    <button class="abtn o" style="margin:0;flex:1;min-width:160px" onclick="runScan()" id="scBtn">⊕ SCAN ALL MARKETS</button>
    <div style="font-family:var(--mn);font-size:9px;color:var(--dm)" id="lastScan">Never scanned</div>
  </div>
  <div class="scanning" id="scScan" style="color:#ff8c00">SCANNING ALL MARKETS...</div>
  <div id="scResults"></div>
  <div class="disc">⚠ Live Deriv data. Statistical analysis only — not financial advice.</div>
</div>

<script>
// ══════════════════════════════════════════════
// FAST WEBSOCKET ENGINE
// ══════════════════════════════════════════════
const WS_URL='wss://ws.binaryws.com/websockets/v3?app_id=1';
const SYM={R_10:'V10',R_25:'V25',R_50:'V50',R_75:'V75',R_100:'V100','1HZ10V':'V10 1s','1HZ25V':'V25 1s','1HZ50V':'V50 1s','1HZ75V':'V75 1s','1HZ100V':'V100 1s'};
const ALL=Object.keys(SYM);
const is1s=s=>s.startsWith('1HZ');
const px={},dg={},tc={},hd={};
ALL.forEach(s=>{px[s]=[];dg[s]=[];tc[s]=0;hd[s]=false;});
let ws=null,wsOk=false,reTm=null,scanQ={},scanTotal=0;
const subbed=new Set(),pendQ=[];

function wsSend(o){try{ws&&ws.readyState===1?ws.send(JSON.stringify(o)):pendQ.push(o);}catch(e){}}

function initWS(){
  try{
    if(ws)try{ws.close();}catch(e){}
    ws=new WebSocket(WS_URL);
    ws.onopen=()=>{
      wsOk=true;setConn('live');
      while(pendQ.length)try{ws.send(JSON.stringify(pendQ.shift()));}catch(e){}
      subInst(rfInst);subInst(dInst);subInst(dmInst);
    };
    ws.onmessage=e=>{
      try{
        const d=JSON.parse(e.data);
        if(!d||d.error)return;
        if(d.msg_type==='history'&&d.history){
          const s=d.echo_req.ticks_history;
          const p=(d.history.prices||[]).map(Number);
          px[s]=p;dg[s]=p.map(ldig);
          if(dg[s].length>50)dg[s]=dg[s].slice(-50);
          hd[s]=true;markLive(s);
          if(s===rfInst){drawChart(px[rfInst]);updRFLast();}
          if(s===dInst){seedStream('srow',dg[dInst]);renderFreq('dfChart','dfLbl',dg[dInst],true);}
          if(s===dmInst){seedStream('dmrow',dg[dmInst]);renderFreq('dmdfChart','dmdfLbl',dg[dmInst],false);}
          if(s in scanQ){scanQ[s]={p:px[s],d:dg[s]};chkScan();}
        }
        if(d.msg_type==='tick'&&d.tick){
          const s=d.tick.symbol,price=Number(d.tick.quote),digit=ldig(d.tick.quote);
          px[s].push(price);if(px[s].length>100)px[s].shift();
          dg[s].push(digit);if(dg[s].length>50)dg[s].shift();
          tc[s]++;hd[s]=true;markLive(s);
          if(s===rfInst){drawChart(px[s]);updRFLast();document.getElementById('rfTC').textContent=tc[s];}
          if(s===dInst){addStream('srow',digit);renderFreq('dfChart','dfLbl',dg[s],true);document.getElementById('dLast').textContent=digit;document.getElementById('dInfo').textContent=`${tc[s]} ticks · ${is1s(s)?'~1s':'~2s'}/tick · ${d.tick.quote}`;document.getElementById('dSpd').textContent=is1s(s)?'~1s':'~2s';}
          if(s===dmInst){addStream('dmrow',digit);renderFreq('dmdfChart','dmdfLbl',dg[s],false);document.getElementById('dmLast').textContent=digit;document.getElementById('dmInfo').textContent=`${tc[s]} ticks`;}
          if(s===eoInst){addEOStream(digit);document.getElementById('eoLast').textContent=digit;document.getElementById('eoInfo').textContent=`${tc[s]} ticks · ${digit%2===0?'EVEN':'ODD'}`;updEOFreq(dg[s]);}
          // BOT: react to every tick - tick-speed execution
          try{botOnTick();}catch(e){}
        }
      }catch(e){}
    };
    ws.onerror=()=>{wsOk=false;setConn('offline');};
    ws.onclose=()=>{wsOk=false;setConn('offline');clearTimeout(reTm);reTm=setTimeout(initWS,4000);};
  }catch(e){setConn('offline');clearTimeout(reTm);reTm=setTimeout(initWS,5000);}
}

function subInst(s){
  if(!subbed.has(s)){
    wsSend({ticks_history:s,count:60,end:'latest',style:'ticks',subscribe:0});
    wsSend({ticks:s,subscribe:1});
    subbed.add(s);
  }
}

const ldig=q=>{const s=String(q);return parseInt(s[s.length-1])||0;};

function setConn(st){
  const pill=document.getElementById('connPill'),dot=document.getElementById('connDot'),txt=document.getElementById('connTxt'),ban=document.getElementById('banner');
  pill.className='pill '+st;dot.className='ldot '+st;
  if(st==='live'){txt.textContent='LIVE';ban.className='live';ban.textContent='[OK] Connected to Deriv live data feed';}
  else if(st==='connecting'){txt.textContent='CONNECTING';ban.className='connecting';ban.textContent='[~] Connecting...';}
  else{txt.textContent='OFFLINE';ban.className='offline';ban.textContent='[X] Offline - simulated data';}
}

function markLive(s){
  document.querySelectorAll('.ib').forEach(b=>{if((b.getAttribute('onclick')||'').includes("'"+s+"'"))b.classList.add('lv-on');});
  const badge='<span class="livebadge">LIVE</span>';
  if(s===rfInst)document.getElementById('rfLiveBadge').innerHTML=badge;
  if(s===dInst)document.getElementById('dLiveBadge').innerHTML=badge;
  if(s===dmInst)document.getElementById('dmLiveBadge').innerHTML=badge;
}

// Simulation
const BASES={R_10:1200,R_25:3500,R_50:4200,R_75:5800,R_100:8500,'1HZ10V':1200,'1HZ25V':3500,'1HZ50V':4200,'1HZ75V':5800,'1HZ100V':8500};
const VOLS={R_10:.3,R_25:.8,R_50:1.5,R_75:3,R_100:6,'1HZ10V':.35,'1HZ25V':.95,'1HZ50V':1.8,'1HZ75V':3.5,'1HZ100V':7};
function simPx(s,n=65){let b=BASES[s]||1e3,v=VOLS[s]||1,o=[];for(let i=0;i<n;i++){b+=(Math.random()-.5)*v*2;o.push(+b.toFixed(2));}return o;}
function simDg(n=50){return Array.from({length:n},()=>Math.floor(Math.random()*10));}
function getPx(s){return px[s]&&px[s].length>=30?px[s]:simPx(s);}
function getDg(s){return dg[s]&&dg[s].length>=15?dg[s]:simDg();}

setInterval(()=>{try{document.getElementById('clk').textContent=new Date().toTimeString().slice(0,8);}catch(e){}},1000);
function swTab(id,el){document.querySelectorAll('.tc').forEach(t=>t.classList.remove('on'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));document.getElementById('tab-'+id).classList.add('on');el.classList.add('on');}

// Chart
function drawChart(p){
  try{
    if(!p||p.length<2)return;
    const c=document.getElementById('rfChart'),w=c.parentElement.clientWidth-28;
    c.width=w;c.height=130;
    const ctx=c.getContext('2d'),h=130,pad=6,mn=Math.min(...p),mx=Math.max(...p),rng=mx-mn||1;
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle='rgba(28,50,72,.5)';ctx.lineWidth=1;
    for(let i=0;i<=3;i++){const y=pad+(h-2*pad)*i/3;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
    const g=ctx.createLinearGradient(0,0,0,h);g.addColorStop(0,'rgba(0,212,255,.18)');g.addColorStop(1,'rgba(0,212,255,0)');
    ctx.beginPath();p.forEach((v,i)=>{const x=pad+(w-2*pad)*i/(p.length-1),y=h-pad-((v-mn)/rng)*(h-2*pad);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.lineTo(pad+(w-2*pad),h-pad);ctx.lineTo(pad,h-pad);ctx.closePath();ctx.fillStyle=g;ctx.fill();
    ctx.beginPath();ctx.strokeStyle='#00d4ff';ctx.lineWidth=2;
    p.forEach((v,i)=>{const x=pad+(w-2*pad)*i/(p.length-1),y=h-pad-((v-mn)/rng)*(h-2*pad);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
    ctx.stroke();
    const lx=pad+(w-2*pad),ly=h-pad-((p[p.length-1]-mn)/rng)*(h-2*pad);
    ctx.beginPath();ctx.arc(lx,ly,5,0,Math.PI*2);ctx.fillStyle='#00d4ff';ctx.fill();ctx.strokeStyle='#060c12';ctx.lineWidth=2;ctx.stroke();
  }catch(e){}
}
window.addEventListener('resize',()=>{try{drawChart(getPx(rfInst));}catch(e){}});
function updRFLast(){try{const p=px[rfInst];if(p&&p.length>0)document.getElementById('rfLast').textContent=p[p.length-1].toFixed(2);}catch(e){}}

// ── RF ──
let rfInst='R_10',rfTickOvr=null,rfMaxR=0,rfRDone=0,rfETi=null;
const rfSt={t:0,r:0,f:0};
function selRF(el,s){document.querySelectorAll('#tab-rf .ib').forEach(b=>b.classList.remove('on'));el.classList.add('on');rfInst=s;document.getElementById('rfLbl').textContent=SYM[s];document.getElementById('rf1sBadge').style.display=is1s(s)?'inline':'none';document.getElementById('rf1sNote').style.display=is1s(s)?'block':'none';document.getElementById('rfLiveBadge').innerHTML=hd[s]?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>';document.getElementById('rfTC').textContent=tc[s]||0;drawChart(getPx(s));updRFLast();subInst(s);}
function setTick(el,n){document.querySelectorAll('.tbtn').forEach(b=>b.classList.remove('on'));el.classList.add('on');rfTickOvr=n;}

const ema=(a,n)=>{const k=2/(n+1);let e=a[0];for(let i=1;i<a.length;i++)e=a[i]*k+e*(1-k);return e;};
const calcRSI=(p,n=14)=>{if(p.length<n+1)return 50;let g=0,l=0;for(let i=p.length-n;i<p.length;i++){const d=p[i]-p[i-1];d>0?g+=d:l+=Math.abs(d);}return+(100-100/(1+g/(l||.001))).toFixed(2);};
const calcMACD=p=>p.length<27?0:+(ema(p,12)-ema(p,26)).toFixed(4);
const calcBB=p=>{const n=Math.min(20,p.length),sl=p.slice(-n),m=sl.reduce((a,b)=>a+b,0)/n;return+(Math.sqrt(sl.reduce((a,b)=>a+(b-m)**2,0)/n)*2).toFixed(4);};
const calcEMA=p=>p.length<22?0:+(ema(p,9)-ema(p,21)).toFixed(4);
const calcSto=p=>{const n=Math.min(14,p.length),sl=p.slice(-n),lo=Math.min(...sl),hi=Math.max(...sl);return hi===lo?50:+((p[p.length-1]-lo)/(hi-lo)*100).toFixed(2);};
const calcMom=p=>+(p[p.length-1]-(p[Math.max(0,p.length-11)]||p[0])).toFixed(4);
const mxRuns=(c,s)=>c>=70?(s?2:3):c>=55?(s?1:2):0;
const expS=(c,s,t)=>{const r=mxRuns(c,s);return r===0?12:Math.max(15,Math.round(t*(s?1:2)*r*1.8));};

function runRF(){
  const btn=document.getElementById('rfBtn'),scn=document.getElementById('rfScan');
  btn.disabled=true;btn.style.opacity='.35';scn.style.display='block';
  const p=getPx(rfInst);
  setTimeout(()=>{
    try{
      drawChart(p);
      const rsi=calcRSI(p),macd=calcMACD(p),bb=calcBB(p),em=calcEMA(p),sto=calcSto(p),mom=calcMom(p);
      let sc=0,sg={};
      sc+=(rsi<35?2:rsi>65?-2:0);sg.rsi=rsi<35?'buy':rsi>65?'sell':'neutral';
      sc+=(macd>0?1:macd<0?-1:0);sg.macd=macd>0?'buy':macd<0?'sell':'neutral';
      const bbN=bb/(p[p.length-1]*.01);sc+=(bbN<.5?1:bbN>1.5?-1:0);sg.bb=bbN<.5?'buy':bbN>1.5?'sell':'neutral';
      sc+=(em>0?2:em<0?-2:0);sg.ema=em>0?'buy':em<0?'sell':'neutral';
      sc+=(sto<25?1:sto>75?-1:0);sg.sto=sto<25?'buy':sto>75?'sell':'neutral';
      sc+=(mom>0?1:mom<0?-1:0);sg.mom=mom>0?'buy':mom<0?'sell':'neutral';
      const ab=Math.abs(sc),conf=ab>=7?75+Math.floor(Math.random()*8):ab>=4?58+Math.floor(Math.random()*10):40+Math.floor(Math.random()*12);
      const sig=sc>=2?'HIGHER':sc<=-2?'LOWER':'WAIT';
      const vp=Math.min(100,bb/p[p.length-1]*10000),s1=is1s(rfInst);
      const tix=rfTickOvr||(s1?(vp>70?5:vp>40?7:10):(vp>70?1:vp>40?3:5));
      const mr=mxRuns(conf,s1);rfMaxR=mr;rfRDone=0;
      [['rsi',rsi,sg.rsi],['macd',macd,sg.macd],['bb',bbN.toFixed(2),sg.bb],['ema',em,sg.ema],['sto',sto,sg.sto],['mom',mom,sg.mom]].forEach(([k,v,s])=>{document.getElementById(k+'V').textContent=v;const el=document.getElementById(k+'S');el.className='is '+s;el.textContent=s==='buy'?'HIGHER':s==='sell'?'LOWER':'WAIT';});
      document.getElementById('rfCard').className='sc '+(sig==='HIGHER'?'rise':sig==='LOWER'?'fall':'wait');
      const sv=document.getElementById('rfSv');sv.className='sv '+(sig==='HIGHER'?'rise':sig==='LOWER'?'fall':'wait');sv.textContent=sig;
      document.getElementById('rfBg').textContent=sig==='RISE'?'UP':sig==='FALL'?'DN':'-';
      document.getElementById('rfDesc').textContent=sig==='HIGHER'?`Bullish - HIGHER (${tix} ticks)`:sig==='LOWER'?`Bearish - LOWER (${tix} ticks)`:'Mixed - wait for confluence';
      document.getElementById('rfTicks').textContent=tix;
      document.getElementById('rfRuns').textContent=mr||'WAIT';
      document.getElementById('rfRuns').style.color=mr>=3?'#00ff88':mr>=2?'#ffd700':mr===1?'#ff8c00':'#ff3b5c';
      document.getElementById('rfCpct').textContent=conf+'%';
      const cf=document.getElementById('rfCf');cf.style.width=conf+'%';cf.style.background=conf>65?'#00ff88':conf>50?'#ffd700':'#ff3b5c';
      updVol(vp,s1);
      if(sig!=='WAIT'&&mr>0){buildDots('rfDots',mr);document.getElementById('rfRW').style.display='block';document.getElementById('rfMb').disabled=false;document.getElementById('rfMb').style.opacity='1';startExp('rf',expS(conf,s1,tix));}
      else{document.getElementById('rfRW').style.display='none';document.getElementById('rfEW').style.display='none';if(rfETi)clearInterval(rfETi);}
      if(sig!=='WAIT'){rfSt.t++;sig==='HIGHER'?rfSt.r++:rfSt.f++;document.getElementById('rfSC').textContent=rfSt.t;document.getElementById('rfRC').textContent=rfSt.r;document.getElementById('rfFC').textContent=rfSt.f;addRFLog(sig,tix,conf,mr,p[p.length-1]);}
    }catch(e){}
    scn.style.display='none';btn.disabled=false;btn.style.opacity='1';
  },300);
}

function updVol(pct,s1){
  try{
    const bars=document.querySelectorAll('#volB .vbar'),ac=Math.round(pct/10);
    const col=s1?'#ff8c00':(pct>70?'#ff3b5c':pct>40?'#ffd700':'#00ff88');
    document.getElementById('volV').textContent=Math.round(pct);document.getElementById('volV').style.color=col;
    document.getElementById('volL').textContent=s1?(pct>70?'EXTREME 1S':pct>40?'HIGH 1S':'MOD 1S'):(pct>70?'HIGH VOL':pct>40?'MODERATE':'LOW VOL');
    bars.forEach((b,i)=>{b.style.background=i<ac?col:'var(--bd)';b.style.boxShadow=i<ac?`0 0 6px ${col}`:'none';});
  }catch(e){}
}

function buildDots(id,max){const w=document.getElementById(id);w.innerHTML='';for(let i=0;i<max;i++){const d=document.createElement('div');d.className='dot';d.id=`${id}_${i}`;w.appendChild(d);}}

let dETi=null,dmETi=null;
function startExp(which,secs){
  const pre=which,eti=pre==='rf'?rfETi:pre==='d'?dETi:dmETi;
  if(eti)clearInterval(eti);
  let rem=secs,tot=secs;
  document.getElementById(pre+'EW').style.display='block';
  const upd=()=>{const pct=rem/tot*100,col=pct>50?'#00ff88':pct>25?'#ffd700':'#ff3b5c';document.getElementById(pre+'Ep').textContent=rem+'s';document.getElementById(pre+'Ep').style.color=col;document.getElementById(pre+'Ef').style.width=pct+'%';document.getElementById(pre+'Ef').style.background=col;};
  upd();
  const iv=setInterval(()=>{rem--;if(rem<=0){clearInterval(iv);document.getElementById(pre+'Ep').textContent='EXPIRED';document.getElementById(pre+'Ep').style.color='#ff3b5c';document.getElementById(pre+'Ef').style.width='0%';document.getElementById(pre+'Mb').disabled=true;document.getElementById(pre+'Mb').style.opacity='.3';}else upd();},1000);
  if(pre==='rf')rfETi=iv;else if(pre==='d')dETi=iv;else if(pre==='dm')dmETi=iv;else eoETi=iv;
}

function rfMark(){try{if(rfRDone>=rfMaxR)return;document.getElementById(`rfDots_${rfRDone}`)?.classList.add('on');rfRDone++;if(rfRDone>=rfMaxR){document.getElementById('rfMb').disabled=true;document.getElementById('rfMb').style.opacity='.3';if(rfETi)clearInterval(rfETi);document.getElementById('rfEf').style.width='0%';document.getElementById('rfEp').textContent='DONE';}}catch(e){}}
function addRFLog(sig,tix,conf,runs,price){try{const tb=document.getElementById('rfLog');if(tb.querySelector('td[colspan]'))tb.innerHTML='';const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date().toTimeString().slice(0,8)}</td><td>${SYM[rfInst]}</td><td class="${sig==='HIGHER'?'win':'loss'}">${sig}</td><td>${tix}</td><td>${conf}%</td><td style="color:#ffd700">${runs}</td><td style="color:#00d4ff">${price}</td>`;tb.insertAdjacentElement('afterbegin',tr);if(tb.children.length>10)tb.removeChild(tb.lastChild);}catch(e){}}

// ── STREAM + FREQ ──
function seedStream(id,stream){try{const row=document.getElementById(id);row.innerHTML='';stream.slice(-22).forEach(d=>row.appendChild(mkD(d,false)));const box=row.parentElement;box.scrollLeft=box.scrollWidth;}catch(e){}}
function addStream(id,d){try{const row=document.getElementById(id);row.appendChild(mkD(d,true));while(row.children.length>35)row.removeChild(row.firstChild);const box=row.parentElement;box.scrollLeft=box.scrollWidth;}catch(e){}}
function mkD(d,isNew){const el=document.createElement('div');el.className=`sd ${d<=4?'lo':'hi'}${isNew?' new':''}`;el.textContent=d;return el;}

function renderFreq(cId,lId,stream,showStats){
  try{
    if(!stream||!stream.length)return;
    const freq=new Array(10).fill(0);stream.forEach(d=>freq[d]++);
    const maxF=Math.max(...freq)||1,total=stream.length;
    const ch=document.getElementById(cId),lb=document.getElementById(lId);
    ch.innerHTML='';lb.innerHTML='';
    freq.forEach((f,d)=>{
      const lo=d<=4,col=lo?'#00ff88':'#ff3b5c';
      const col2=document.createElement('div');col2.className='dfc';
      const bar=document.createElement('div');bar.className='dfb';bar.style.height=Math.max(2,f/maxF*68)+'px';bar.style.background=col;bar.style.opacity=.3+f/maxF*.7;
      const cnt=document.createElement('div');cnt.className='dfcnt';cnt.style.color=col;cnt.textContent=f;
      col2.appendChild(bar);col2.appendChild(cnt);ch.appendChild(col2);
      const sp=document.createElement('span');sp.style.color=col;sp.textContent=d;lb.appendChild(sp);
    });
    if(showStats){
      const lo=freq.slice(0,5).reduce((a,b)=>a+b,0),lp=Math.round(lo/total*100),hp=100-lp;
      document.getElementById('dLow').textContent=lp+'%';document.getElementById('dHigh').textContent=hp+'%';
      const lt=document.getElementById('dLT');lt.innerHTML='';freq.slice(0,5).forEach((f,i)=>{const t=document.createElement('div');t.style.cssText='font-family:var(--mn);font-size:9px;padding:2px 5px;border-radius:2px;background:rgba(0,255,136,.08);color:#00ff88;border:1px solid rgba(0,255,136,.15);';t.textContent=`${i}:${f}`;lt.appendChild(t);});
      const ht=document.getElementById('dHT');ht.innerHTML='';freq.slice(5).forEach((f,i)=>{const t=document.createElement('div');t.style.cssText='font-family:var(--mn);font-size:9px;padding:2px 5px;border-radius:2px;background:rgba(255,59,92,.08);color:#ff3b5c;border:1px solid rgba(255,59,92,.15);';t.textContent=`${i+5}:${f}`;ht.appendChild(t);});
    }
    return freq;
  }catch(e){}
}

// ── OVER/UNDER ANALYSIS ──
function analyseOD(stream,inst){
  if(!stream||stream.length<10)return{dir:'WAIT',ent:null,cond:'Need more ticks...',conf:0,runs:0,sL:0,sD:null,lp:50,hp:50};
  const freq=new Array(10).fill(0);stream.forEach(d=>freq[d]++);
  const total=stream.length,lo=freq.slice(0,5).reduce((a,b)=>a+b,0);
  const lp=lo/total*100,dev=lp-50;
  let sD=null,sL=0;
  for(let i=stream.length-1;i>=0;i--){const isLo=stream[i]<=4;if(i===stream.length-1){sD=isLo?'lo':'hi';sL=1;}else if((isLo&&sD==='lo')||(!isLo&&sD==='hi'))sL++;else break;}
  let dir,ent,cond,conf;const s1=is1s(inst);
  if(dev<=-8){dir='OVER';ent=dev<=-15?0:dev<=-12?1:dev<=-10?2:3;conf=Math.min(76,52+Math.abs(dev)*1.1);cond=`Low ${Math.round(lp)}% from ${total} ticks - reversion favours OVER ${ent}.`;}
  else if(dev>=8){dir='UNDER';ent=dev>=15?9:dev>=12?8:dev>=10?7:6;conf=Math.min(76,52+Math.abs(dev)*1.1);cond=`High ${Math.round(100-lp)}% from ${total} ticks - UNDER ${ent} favoured.`;}
  else if(sL>=5&&sD==='lo'){dir='UNDER';ent=5;conf=Math.min(70,48+sL*3);cond=`${sL}-tick LOW streak - break likely, UNDER 5.`;}
  else if(sL>=5&&sD==='hi'){dir='OVER';ent=4;conf=Math.min(70,48+sL*3);cond=`${sL}-tick HIGH streak - break likely, OVER 4.`;}
  else{dir='WAIT';ent=null;conf=0;cond=`Balanced: Low ${Math.round(lp)}% / High ${Math.round(100-lp)}% - wait for ≥8% deviation.`;}
  // Over/Under always 1 tick - runs = number of contracts recommended
  const runs=dir==='WAIT'?0:conf>=68?(s1?3:5):conf>=58?(s1?2:3):(s1?1:2);
  return{dir,ent,cond,conf:Math.round(conf),runs,dur:1,sL,sD,lp:Math.round(lp),hp:Math.round(100-lp)};
}

let dInst='R_75',dMaxR=0,dRDone=0;
function selD(el,s){document.querySelectorAll('#tab-dg .ib').forEach(b=>b.classList.remove('on'));el.classList.add('on');dInst=s;document.getElementById('dLbl').textContent=SYM[s];document.getElementById('dSpd').textContent=is1s(s)?'~1s':'~2s';document.getElementById('dLiveBadge').innerHTML=hd[s]?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>';seedStream('srow',getDg(s));renderFreq('dfChart','dfLbl',getDg(s),true);subInst(s);}

function runD(){
  const btn=document.getElementById('dBtn'),scn=document.getElementById('dScan');
  btn.disabled=true;btn.style.opacity='.35';scn.style.display='block';
  setTimeout(()=>{
    try{
      const stream=getDg(dInst);renderFreq('dfChart','dfLbl',stream,true);
      const r=analyseOD(stream,dInst);
      document.getElementById('dDir').textContent=r.dir;document.getElementById('dDir').className=`dsv ${r.dir==='OVER'?'g':r.dir==='UNDER'?'r':'y'}`;
      document.getElementById('dDirCell').className=`dsc ${r.dir==='OVER'?'g':r.dir==='UNDER'?'r':'y'}`;
      document.getElementById('dEnt').textContent=r.ent!==null?r.ent:'-';
      document.getElementById('dRns').textContent=r.runs||'WAIT';document.getElementById('dRns').style.color=r.runs>=4?'#00ff88':r.runs>=2?'#ffd700':r.runs===1?'#ff8c00':'#ff3b5c';
      document.getElementById('dStr').textContent=r.sL+(r.sD?' '+(r.sD==='lo'?'↓':'↑'):'');
      document.getElementById('dCond').textContent=r.cond;document.getElementById('dCpct').textContent=r.conf+'%';
      const cf=document.getElementById('dCf');cf.style.width=r.conf+'%';cf.style.background=r.conf>65?'#00ff88':r.conf>50?'#ffd700':'#ff3b5c';
      dMaxR=r.runs;dRDone=0;
      if(r.runs>0){buildDots('dDots',r.runs);document.getElementById('dRW').style.display='block';document.getElementById('dMb').disabled=false;document.getElementById('dMb').style.opacity='1';document.getElementById('dRN').textContent=`${r.runs} run${r.runs>1?'s':''} × 1 tick = ${r.runs} contracts`;startExp('d',Math.max(12,r.runs*(is1s(dInst)?4:6)));}
      else{document.getElementById('dRW').style.display='none';document.getElementById('dEW').style.display='none';if(dETi)clearInterval(dETi);}
      addDLog(r);
    }catch(e){}
    scn.style.display='none';btn.disabled=false;btn.style.opacity='1';
  },250);
}

function dMark(){try{if(dRDone>=dMaxR)return;document.getElementById(`dDots_${dRDone}`)?.classList.add('on');dRDone++;if(dRDone>=dMaxR){document.getElementById('dMb').disabled=true;document.getElementById('dMb').style.opacity='.3';if(dETi)clearInterval(dETi);document.getElementById('dEf').style.width='0%';document.getElementById('dEp').textContent='DONE';document.getElementById('dRN').textContent='[OK] Done - re-analyse';}}catch(e){}}
function addDLog(r){try{const tb=document.getElementById('dLog');if(tb.querySelector('td[colspan]'))tb.innerHTML='';const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date().toTimeString().slice(0,8)}</td><td>${SYM[dInst]}</td><td class="${r.dir==='OVER'?'win':r.dir==='UNDER'?'loss':'wt'}">${r.dir}</td><td style="color:#00d4ff">${r.ent!==null?r.ent:'-'}</td><td style="font-size:9px">${r.cond.slice(0,34)}…</td><td style="color:#ffd700">${r.runs}</td><td style="color:#00ff88">${r.lp}%</td><td style="color:#ff3b5c">${r.hp}%</td>`;tb.insertAdjacentElement('afterbegin',tr);if(tb.children.length>8)tb.removeChild(tb.lastChild);}catch(e){}}

// ── DIFFER/MATCH ──
let dmInst='R_75',dmMaxR=0,dmRDone=0;
function selDM(el,s){document.querySelectorAll('#tab-dm .ib').forEach(b=>b.classList.remove('on'));el.classList.add('on');dmInst=s;document.getElementById('dmLbl').textContent=SYM[s];document.getElementById('dmLiveBadge').innerHTML=hd[s]?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>';seedStream('dmrow',getDg(s));renderFreq('dmdfChart','dmdfLbl',getDg(s),false);subInst(s);}

function analyseDM(stream,inst){
  if(!stream||stream.length<10)return{type:'WAIT',digit:null,cond:'Need more ticks...',conf:0,runs:0,sL:0,lastD:null};
  const last10=stream.slice(-10),freq10=new Array(10).fill(0);last10.forEach(d=>freq10[d]++);
  const lastD=stream[stream.length-1];
  let sL=0;for(let i=stream.length-1;i>=0&&stream[i]===lastD;i--)sL++;
  let hotDig=0,hotF=0;freq10.forEach((f,d)=>{if(f>hotF){hotF=f;hotDig=d;}});
  let coldDig=-1;freq10.forEach((f,d)=>{if(f===0&&coldDig===-1)coldDig=d;});
  if(coldDig===-1){let mn=99;freq10.forEach((f,d)=>{if(f<mn){mn=f;coldDig=d;}});}
  let type,digit,cond,conf;const s1=is1s(inst);
  if(sL>=4){type='DIFFERS';digit=lastD;conf=Math.min(70,50+sL*5);cond=`Digit ${lastD} repeated ${sL}x streak - very likely to differ.`;}
  else if(hotF>=4){type='DIFFERS';digit=hotDig;conf=Math.min(68,46+hotF*5);cond=`Digit ${hotDig} appeared ${hotF}x in last 10 - likely to differ next tick.`;}
  else if(freq10[coldDig]===0){type='MATCHES';digit=coldDig;conf=55;cond=`Digit ${coldDig} absent from last 10 ticks - matches ${coldDig} due.`;}
  else if(hotF>=3){type='DIFFERS';digit=hotDig;conf=Math.min(62,44+hotF*4);cond=`Digit ${hotDig} hot (${hotF}x/10) - differs favoured.`;}
  else{type='WAIT';digit=null;conf=0;cond=`Even distribution. No strong differ/match pattern yet.`;}
  const runs=type==='WAIT'?0:conf>=62?(s1?2:3):(s1?1:2);
  return{type,digit,cond,conf:Math.round(conf),runs,sL,lastD};
}

function runDM(){
  const btn=document.getElementById('dmBtn'),scn=document.getElementById('dmScan');
  btn.disabled=true;btn.style.opacity='.35';scn.style.display='block';
  setTimeout(()=>{
    try{
      const stream=getDg(dmInst);renderFreq('dmdfChart','dmdfLbl',stream,false);
      const r=analyseDM(stream,dmInst);
      const isDiff=r.type==='DIFFERS',isMatch=r.type==='MATCHES';
      document.getElementById('dmDir').textContent=r.type;document.getElementById('dmDir').className=`dsv ${isDiff?'pu':isMatch?'a':'y'}`;
      document.getElementById('dmDirCell').className=`dsc ${isDiff?'pu':isMatch?'a':'y'}`;
      document.getElementById('dmDig').textContent=r.digit!==null?r.digit:'-';
      document.getElementById('dmRns').textContent=r.runs||'WAIT';document.getElementById('dmRns').style.color=r.runs>=3?'#00ff88':r.runs>=2?'#ffd700':'#ff8c00';
      document.getElementById('dmStr').textContent=r.sL+(r.lastD!==null?' ('+r.lastD+')':'');
      document.getElementById('dmCond').textContent=r.cond;document.getElementById('dmCpct').textContent=r.conf+'%';
      const cf=document.getElementById('dmCf');cf.style.width=r.conf+'%';cf.style.background=isDiff?'#b388ff':isMatch?'#00d4ff':'#ffd700';
      dmMaxR=r.runs;dmRDone=0;
      if(r.runs>0){buildDots('dmDots',r.runs);document.getElementById('dmRW').style.display='block';document.getElementById('dmMb').disabled=false;document.getElementById('dmMb').style.opacity='1';document.getElementById('dmRN').textContent=`${r.type} digit ${r.digit} - ${r.runs} run${r.runs>1?'s':''}`;startExp('dm',Math.max(10,r.runs*(is1s(dmInst)?3:5)));}
      else{document.getElementById('dmRW').style.display='none';document.getElementById('dmEW').style.display='none';if(dmETi)clearInterval(dmETi);}
      addDMLog(r);
    }catch(e){}
    scn.style.display='none';btn.disabled=false;btn.style.opacity='1';
  },250);
}

function dmMark(){try{if(dmRDone>=dmMaxR)return;document.getElementById(`dmDots_${dmRDone}`)?.classList.add('on');dmRDone++;if(dmRDone>=dmMaxR){document.getElementById('dmMb').disabled=true;document.getElementById('dmMb').style.opacity='.3';if(dmETi)clearInterval(dmETi);document.getElementById('dmEf').style.width='0%';document.getElementById('dmEp').textContent='DONE';document.getElementById('dmRN').textContent='[OK] Done - re-analyse';}}catch(e){}}
function addDMLog(r){try{const tb=document.getElementById('dmLog');if(tb.querySelector('td[colspan]'))tb.innerHTML='';const tr=document.createElement('tr');const col=r.type==='DIFFERS'?'style="color:#b388ff"':r.type==='MATCHES'?'style="color:#00d4ff"':'class="wt"';tr.innerHTML=`<td>${new Date().toTimeString().slice(0,8)}</td><td>${SYM[dmInst]}</td><td ${col}>${r.type}</td><td style="color:#00d4ff">${r.digit!==null?r.digit:'-'}</td><td style="font-size:9px">${r.cond.slice(0,34)}…</td><td style="color:#ffd700">${r.runs}</td><td>${r.conf}%</td>`;tb.insertAdjacentElement('afterbegin',tr);if(tb.children.length>8)tb.removeChild(tb.lastChild);}catch(e){}}

// ── SCANNER ──
let favO=2,favU=7,favDif=5,favMat=5;
function updFavs(){favO=+document.getElementById('fovS').value;favU=+document.getElementById('fundS').value;favDif=+document.getElementById('fdifS').value;favMat=+document.getElementById('fmatS').value;document.getElementById('fovD').textContent=favO;document.getElementById('fundD').textContent=favU;document.getElementById('fdifD').textContent=favDif;document.getElementById('fmatD').textContent=favMat;}

function chkScan(){
  if(Object.values(scanQ).filter(v=>v!==null).length>=scanTotal)buildScanResults();
}

function buildScanResults(){
  try{
    const ouR=ALL.map(inst=>{const e=scanQ[inst];const s=e&&e.d&&e.d.length>=10?e.d:getDg(inst);return{inst,r:analyseOD(s,inst),live:!!(e&&e.d),mode:'ou'};});
    const dmR=ALL.map(inst=>{const e=scanQ[inst];const s=e&&e.d&&e.d.length>=10?e.d:getDg(inst);const r=analyseDM(s,inst);return{inst,r:{dir:r.type,ent:r.digit,conf:r.conf,runs:r.runs,lp:0,hp:0,cond:r.cond},live:!!(e&&e.d),mode:'dm'};});
    const eoR=ALL.map(inst=>{const e=scanQ[inst];const s=e&&e.d&&e.d.length>=10?e.d:getDg(inst);const r=analyseEO(s,inst);return{inst,r:{dir:r.dir,ent:null,conf:r.conf,runs:r.runs,lp:r.evenPct,hp:r.oddPct,cond:r.cond},live:!!(e&&e.d),mode:'eo'};});
    const all=[...ouR,...dmR,...eoR].sort((a,b)=>{if(a.r.dir==='WAIT'&&b.r.dir!=='WAIT')return 1;if(b.r.dir==='WAIT'&&a.r.dir!=='WAIT')return -1;return b.r.conf-a.r.conf;});
    renderScan(all);
    document.getElementById('lastScan').textContent='Last: '+new Date().toTimeString().slice(0,8);
    document.getElementById('scScan').style.display='none';
    document.getElementById('scBtn').disabled=false;document.getElementById('scBtn').style.opacity='1';
  }catch(e){document.getElementById('scScan').style.display='none';document.getElementById('scBtn').disabled=false;document.getElementById('scBtn').style.opacity='1';}
}

function runScan(){
  const btn=document.getElementById('scBtn'),scn=document.getElementById('scScan');
  btn.disabled=true;btn.style.opacity='.35';scn.style.display='block';
  document.getElementById('scResults').innerHTML='';document.getElementById('bestPanel').style.display='none';
  if(!wsOk){buildScanResults();return;}
  ALL.forEach(s=>{scanQ[s]=null;});scanTotal=ALL.length;
  ALL.forEach((s,i)=>setTimeout(()=>wsSend({ticks_history:s,count:50,end:'latest',style:'ticks',subscribe:0}),i*80));
  setTimeout(()=>{if(document.getElementById('scScan').style.display!=='none')buildScanResults();},7000);
}

const getCol=dir=>dir==='OVER'?'#00ff88':dir==='UNDER'?'#ff3b5c':dir==='DIFFERS'?'#b388ff':dir==='MATCHES'?'#00d4ff':'#ffd700';
const chkFav=(x)=>{const d=x.r.dir,e=x.r.ent;return(d==='OVER'&&e===favO)||(d==='UNDER'&&e===favU)||(d==='DIFFERS'&&e===favDif)||(d==='MATCHES'&&e===favMat);};

function renderScan(results){
  try{
    const wrap=document.getElementById('scResults');wrap.innerHTML='';
    const best=results.find(x=>x.r.dir!=='WAIT');
    if(best){
      const bp=document.getElementById('bestPanel');bp.style.display='block';
      const col=getCol(best.r.dir);
      document.getElementById('bestContent').innerHTML=`
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="font-family:var(--mn);font-size:13px;color:var(--tx)">${SYM[best.inst]}</div>
          <div style="font-family:var(--dp);font-size:38px;font-weight:900;color:${col}">${best.r.dir}</div>
          <div style="font-family:var(--dp);font-size:38px;font-weight:900;color:#00d4ff">${best.r.ent!==null?best.r.ent:'-'}</div>
          <div style="flex:1;min-width:110px"><div style="display:flex;justify-content:space-between;font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:3px"><span>CONFIDENCE</span><span style="color:${col}">${best.r.conf}%</span></div><div style="height:4px;background:var(--bd);border-radius:2px;overflow:hidden"><div style="height:100%;width:${best.r.conf}%;background:${col};border-radius:2px"></div></div></div>
          ${chkFav(best)?'<div style="font-family:var(--mn);font-size:9px;background:rgba(255,215,0,.1);color:#ffd700;border:1px solid rgba(255,215,0,.25);padding:3px 9px;border-radius:3px;">* YOUR FAV</div>':''}
          ${best.live?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>'}
        </div>
        <div style="font-family:var(--mn);font-size:10px;color:var(--dm);margin-top:7px;line-height:1.7">${best.r.cond}</div>
        <div style="font-family:var(--mn);font-size:9px;color:#ffd700;margin-top:4px">Max runs: ${best.r.runs}${best.mode==='ou'?' · Low: '+best.r.lp+'% · High: '+best.r.hp+'%':''}</div>
        <button onclick="scanTrade('${best.r.dir}','${best.inst}',${best.r.ent},${best.r.runs})"
          style="margin-top:10px;width:100%;padding:13px;background:rgba(0,255,136,.15);border:2px solid #00ff88;color:#00ff88;font-family:var(--dp);font-size:15px;font-weight:900;letter-spacing:2px;border-radius:6px;cursor:pointer;">
          [!] TRADE BEST SIGNAL
        </button>`;
    }
    const hdr=document.createElement('div');hdr.style.cssText='font-family:var(--mn);font-size:9px;color:var(--dm);letter-spacing:2px;padding:4px 0 8px;text-transform:uppercase;';hdr.textContent='All Markets - Ranked by Confidence';wrap.appendChild(hdr);
    results.forEach((x,rank)=>{
      const{inst,r,live,mode}=x,isW=r.dir==='WAIT';
      const col=getCol(r.dir),cls=r.dir==='OVER'?'over':r.dir==='UNDER'?'under':r.dir==='DIFFERS'?'diff':r.dir==='MATCHES'?'match':'wait';
      const card=document.createElement('div');card.className=`scard ${cls}${rank===0&&!isW?' top-pick':''}`;
      card.innerHTML=`
        ${chkFav(x)?'<div class="favbadge">* FAV</div>':`<div class="srank">#${rank+1}</div>`}
        <div class="sinst">${SYM[inst]}${is1s(inst)?'<div style="font-family:var(--mn);font-size:8px;color:#ff8c00">[!]1s</div>':''}<div style="margin-top:2px">${live?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>'}</div></div>
        <div><div class="sdir ${cls}">${r.dir}</div><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">DIGIT</div><div class="sdg">${r.ent!==null?r.ent:'-'}</div></div>
        <div class="sbars">
          ${mode==='ou'?`<div class="sbrow"><div class="sblbl" style="color:#00ff88">LO</div><div class="sbbg"><div class="sbf" style="width:${r.lp}%;background:#00ff88"></div></div><div style="font-family:var(--mn);font-size:8px;color:#00ff88;min-width:26px;text-align:right">${r.lp}%</div></div><div class="sbrow"><div class="sblbl" style="color:#ff3b5c">HI</div><div class="sbbg"><div class="sbf" style="width:${r.hp}%;background:#ff3b5c"></div></div><div style="font-family:var(--mn);font-size:8px;color:#ff3b5c;min-width:26px;text-align:right">${r.hp}%</div></div>`:`<div class="sbrow"><div class="sblbl" style="color:${col}">${r.dir.slice(0,4)}</div><div class="sbbg"><div class="sbf" style="width:${r.conf}%;background:${col}"></div></div><div style="font-family:var(--mn);font-size:8px;color:${col};min-width:26px;text-align:right">${r.conf}%</div></div>`}
          <div class="scond">${r.cond.slice(0,56)}${r.cond.length>56?'…':''}</div>
        </div>
        <div class="sconf">${isW?'-':r.conf+'%'}<br><span style="color:#ffd700">${r.runs>0?r.runs+'r':'WAIT'}</span></div>
        ${!isW?`<div style="padding:6px 0 2px"><button onclick="scanTrade('${r.dir}','${inst}',${r.ent},${r.runs})"
          style="width:100%;padding:8px;background:rgba(0,255,136,.1);border:1.5px solid rgba(0,255,136,.5);color:#00ff88;font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:1px;border-radius:5px;cursor:pointer;">
          TRADE</button></div>`:''}`;
      wrap.appendChild(card);
    });
  }catch(e){}
}

// ══════════════════════════════════════════════════════
// TRADING ENGINE v4 - PERSISTENT + SEQUENTIAL + FAST
// ══════════════════════════════════════════════════════
let apiToken=null,accountInfo=null,tradeWS=null,tradeWSok=false,tradeReady=false;
let openContracts={};
let contractOpenTimes={}; // track when each contract was opened

// Auto-cleanup ghost contracts every 10s
setInterval(()=>{
  const now=Date.now();
  Object.keys(contractOpenTimes).forEach(id=>{
    if(now-contractOpenTimes[id]>30000){ // 30s timeout
      // Force remove from open positions
      delete openContracts[id];
      delete contractOpenTimes[id];
    }
  });
  renderOpenPos();
},10000);
const tradePendQ=[];
let pingTimer=null;

// Run queue - one trade at a time, wait for result before next
let runQueue=[];
let runExecuting=false;
let currentRunContract=null; // contract_id of currently open run

// ── MARTINGALE ──
// ×3.2 → OVER 0-3, UNDER 6-9, ALL DIFFERS, RISE, FALL
// ×2.1 → OVER 4, UNDER 5
// ×1.5 → MATCHES (all)
const MG={base:1,current:1,wins:0,losses:0,streak:0,totalPnl:0,lastType:null,lastBarrier:null,lastSym:null,lastStake:0};

function mgMult(ct,barrier){
  if(ct==='CALL'||ct==='PUT')return 3.2;
  if(ct==='DIGITDIFF')return 3.2;
  if(ct==='DIGITMATCH')return 1.5;
  if(ct==='DIGITEVEN')return 2.1;
  if(ct==='DIGITODD')return 2.1;
  if(ct==='DIGITOVER')return(barrier!==null&&barrier!==undefined&&parseInt(barrier)<=3)?3.6:2.1;
  if(ct==='DIGITUNDER')return(barrier!==null&&barrier!==undefined&&parseInt(barrier)===5)?2.1:3.6;
  return 3.2;
}

function mgOnResult(won,pnl,ct,barrier){
  if(botRunning)return; // bot has its own result handler
  MG.totalPnl=+(MG.totalPnl+pnl).toFixed(2);
  if(won){
    MG.wins++;MG.streak=0;
    MG.current=MG.base;
    showTradeMsg(`[OK] WIN +$${pnl.toFixed(2)} - stake reset to $${MG.base}`,'#00ff88');
    try{soundWin();}catch(e){}
  } else {
    MG.losses++;MG.streak++;
    const max=parseFloat(document.getElementById('maxStake')?.value||'50');
    const mult=mgMult(ct,barrier);
    const next=+(MG.current*mult).toFixed(2);
    if(next>max){
      MG.current=MG.base;
      showTradeMsg(`[X] LOSS $${Math.abs(pnl).toFixed(2)} - max reached, reset to $${MG.base}`,'#ff8c00');
    } else {
      MG.current=next;
      showTradeMsg(`[X] LOSS $${Math.abs(pnl).toFixed(2)} → Martingale ×${mult} → next $${next}`,'#ff3b5c');
      try{soundLoss();}catch(e){}
    }
  }
  try{document.getElementById('stakeAmt').value=MG.current.toFixed(2);}catch(e){}
  updMartStats();
  // Log to trade history - use captured values from buy time
  try{
    const ct=MG.lastType||'UNKNOWN';
    const sym=MG.lastSym||'';
    const bar=MG.lastBarrier;
    const stk=MG.lastStake||parseFloat(MG.current.toFixed(2));
    addTradeHistory(ct,sym,bar,stk,pnl,won);
  }catch(e){}
}

function updMartStats(){
  try{
    document.getElementById('mgStake').textContent='$'+MG.current.toFixed(2);
    const pnl=MG.totalPnl;
    document.getElementById('mgPnl').textContent=(pnl>=0?'+$':'-$')+Math.abs(pnl).toFixed(2);
    document.getElementById('mgPnl').style.color=pnl>=0?'#00ff88':'#ff3b5c';
    document.getElementById('mgW').textContent=MG.wins;
    document.getElementById('mgL').textContent=MG.losses;
    document.getElementById('mgS').textContent=MG.streak+'L';
    document.getElementById('mgS').style.color=MG.streak>2?'#ff3b5c':MG.streak>0?'#ffd700':'#00ff88';
  }catch(e){}
}

// ── WEBSOCKET ──
function tradeSend(o){
  try{
    if(tradeWS&&tradeWS.readyState===1){tradeWS.send(JSON.stringify(o));}
    else{tradePendQ.push(o);}
  }catch(e){tradePendQ.push(o);}
}

function initTradeWS(token){
  try{
    if(tradeWS){try{tradeWS.close();}catch(e){}}
    clearInterval(pingTimer);
    tradeWS=new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1');
    tradeWS.onopen=()=>{
      tradeWSok=true;tradeReady=false;
      tradeWS.send(JSON.stringify({authorize:token}));
      // Keep-alive every 25s
      pingTimer=setInterval(()=>{
        if(tradeWS&&tradeWS.readyState===1)tradeWS.send(JSON.stringify({ping:1}));
      },25000);
    };
    tradeWS.onmessage=e=>{
      try{onTradeMessage(JSON.parse(e.data));}catch(err){}
    };
    tradeWS.onerror=()=>{tradeWSok=false;tradeReady=false;};
    tradeWS.onclose=(e)=>{
      tradeWSok=false;tradeReady=false;
      clearInterval(pingTimer);
      if(apiToken&&accountInfo){
        setTimeout(()=>{if(apiToken&&accountInfo)initTradeWS(apiToken);},2000);
      } else if(apiToken&&!accountInfo){
        const btn=document.getElementById('loginBtn');
        if(btn){btn.disabled=false;btn.style.opacity='1';}
      }
    };
  }catch(e){
    setTimeout(()=>{if(apiToken)initTradeWS(apiToken);},3000);
  }
}

function onTradeMessage(d){
  if(!d)return;

  if(d.msg_type==='authorize'){
    if(d.error){
      const msg=d.error.message||'Auth failed';
      const code=d.error.code||'';
      showTradeMsg(`[ERR] ${msg} (${code}) - ensure token has Read+Trade scopes`,'#ff3b5c');
      const btn=document.getElementById('loginBtn');
      if(btn){btn.disabled=false;btn.style.opacity='1';}
      setLoggedOut();return;
    }
    accountInfo=d.authorize;tradeReady=true;
    MG.base=parseFloat(document.getElementById('stakeAmt')?.value||'1');
    MG.current=MG.base;
    showAccountInfo(d.authorize);
    tradeSend({balance:1,subscribe:1});
    // Flush pending trades
    while(tradePendQ.length){
      try{tradeWS.send(JSON.stringify(tradePendQ.shift()));}catch(e){}
    }
    // Resume any queued runs
    if(runQueue.length&&!runExecuting)nextRun();
  }

  if(d.msg_type==='ping')return; // ignore pings

  if(d.msg_type==='balance'&&d.balance){
    try{document.getElementById('accBal').textContent=parseFloat(d.balance.balance).toFixed(2)+' '+(d.balance.currency||'USD');}catch(e){}
  }

  if(d.msg_type==='buy'){
    if(d.error){
      showTradeMsg('[ERR] Trade error: '+d.error.message,'#ff3b5c');
      runExecuting=false;nextRun();
      return;
    }
    const c=d.buy,ep=d.echo_req?.parameters||{};
    const bar=ep.barrier!==undefined?parseInt(ep.barrier):MG.lastBarrier;
    const ct=ep.contract_type||MG.lastType||'';
    currentRunContract=c.contract_id;
    openContracts[c.contract_id]={
      id:c.contract_id,buy_price:parseFloat(c.buy_price),
      contract_type:ct,underlying:ep.symbol||'',
      barrier:bar,currency:accountInfo?.currency||'USD'
    };
    showTradeMsg(`[!] Run ${runQueue.length>0?'→ '+runQueue.length+' more waiting':''} #${c.contract_id} $${c.buy_price}`,'#00d4ff');
    tradeSend({proposal_open_contract:1,contract_id:c.contract_id,subscribe:1});
    refreshPositions();
  }

  if(d.msg_type==='proposal_open_contract'&&d.proposal_open_contract){
    const c=d.proposal_open_contract;
    if(openContracts[c.contract_id]){
      openContracts[c.contract_id]={...openContracts[c.contract_id],...c};
    }
    // Bot hook
    try{checkBotResult(d);}catch(e){}
    if(c.is_sold){
      pipelineDepth=Math.max(0,pipelineDepth-1);
      delete contractOpenTimes[c.contract_id]; // remove from timeout tracker
      const oc=openContracts[c.contract_id]||{};
      const pnl=+(parseFloat(c.sell_price)-parseFloat(c.buy_price)).toFixed(2);
      const won=pnl>=0;
      const ct=oc.contract_type||c.contract_type||'';
      const barrier=oc.barrier!==undefined?oc.barrier:null;
      mgOnResult(won,pnl,ct,barrier);
      delete openContracts[c.contract_id];
      currentRunContract=null;
      if(runQueue.length===0)runExecuting=false;
      // Pipeline slot freed - fire next if waiting
      if(runQueue.length>0&&pipelineDepth<MAX_PIPELINE){
        setTimeout(()=>nextRun(),50);
      }
    }
    refreshPositions();
  }
}

// ── RUN QUEUE - sequential execution ──

// ── TICK INTERVAL ESTIMATOR ──
// Returns estimated ms per tick for a given instrument
function getTickMs(sym){
  // 1-second instruments tick every ~1000ms
  if(sym&&sym.startsWith('1HZ'))return 1000;
  // Standard instruments tick every ~2000ms
  return 2000;
}

// Pipeline stagger = tick interval - 100ms (fire just before previous closes)
function getPipelineStagger(sym){
  return getTickMs(sym)-100; // e.g. 1HZ → 900ms, standard → 1900ms
}
// Pipeline counter
let pipelineDepth=0;
const MAX_PIPELINE=3;

function firePipelineRun(run,stake){
  if(!accountInfo||!tradeWSok)return;
  const params={
    contract_type:run.ct,symbol:run.sym,
    duration:1,duration_unit:'t',
    basis:'stake',amount:stake,
    currency:accountInfo.currency||'USD'
  };
  if(run.barrier!==null&&run.barrier!==undefined)params.barrier=String(run.barrier);
  MG.lastType=run.ct;MG.lastBarrier=run.barrier!==undefined?run.barrier:null;
  MG.lastSym=run.sym;MG.lastStake=stake;
  pipelineDepth++;
  tradeSend({buy:'1',price:stake,parameters:params});
}

function nextRun(){
  if(runQueue.length===0){runExecuting=false;return;}
  if(!accountInfo||!tradeWSok){setTimeout(()=>nextRun(),300);return;}
  runExecuting=true;

  // Collect all runs in this batch (same symbol = same stagger rhythm)
  const allRuns=[];
  while(runQueue.length>0&&allRuns.length<MAX_PIPELINE){
    allRuns.push(runQueue.shift());
  }

  const sym=allRuns[0].sym;
  const stagger=getPipelineStagger(sym); // tick-locked stagger
  const stake=parseFloat(MG.current.toFixed(2));

  // Fire each run staggered by (tick_ms - 100ms)
  // e.g. V100 1s = 900ms between each
  // Run 1 closes just as Run 2 is opening - perfect relay
  allRuns.forEach((run,i)=>{
    setTimeout(()=>{
      if(!accountInfo||!tradeWSok)return;
      firePipelineRun(run,stake);
    }, i * stagger);
  });

  // Allow new batch after last run fires + 1 tick
  const lastFire=( allRuns.length-1)*stagger;
  const tickMs=getTickMs(sym);
  setTimeout(()=>{
    if(runQueue.length===0)runExecuting=false;
    else nextRun();
  }, lastFire + tickMs + 200);
}

// ── QUEUE TRADES - the ONLY entry point ──
function queueTrades(contractType,symbol,duration,durationUnit,barrier,runs){
  if(!apiToken){showTradeMsg('Enter your API token first','#ff3b5c');return;}
  // LOCK: when bot is running, manual trades are disabled
  if(botRunning){showTradeMsg('[!] Bot is running - stop bot to trade manually','#ff8c00');return;}
  // DIGIT contracts ALWAYS use 1 tick - no exceptions
  const isDigit=['DIGITOVER','DIGITUNDER','DIGITDIFF','DIGITMATCH','DIGITEVEN','DIGITODD'].includes(contractType);
  const finalDur=isDigit?1:Math.max(1,parseInt(duration)||1);
  const numRuns=Math.max(1,parseInt(runs)||1);
  const mult=mgMult(contractType,barrier);

  if(!accountInfo){
    showTradeMsg('[~] Connecting... trade will fire automatically','#ffd700');
    if(!tradeWSok)initTradeWS(apiToken);
    for(let i=0;i<numRuns;i++){
      runQueue.push({ct:contractType,sym:symbol,dur:finalDur,unit:'t',barrier:barrier!==undefined?barrier:null});
    }
    return;
  }
  showTradeMsg(`[!] ${numRuns} run${numRuns>1?'s':''} · ${isDigit?'1 tick each':''+finalDur+' ticks'} · ${SYM[symbol]||symbol} · $${MG.current.toFixed(2)} · ×${mult}`,'#00d4ff');
  for(let i=0;i<numRuns;i++){
    runQueue.push({ct:contractType,sym:symbol,dur:finalDur,unit:'t',barrier:barrier!==undefined?barrier:null});
  }
  if(!runExecuting)nextRun();
}

// ── TRADE BUTTONS ──
function tradeRF(){
  const sig=document.getElementById('rfSv').textContent;
  const tix=parseInt(document.getElementById('rfTicks').textContent)||5;
  const runs=parseInt(document.getElementById('rfRuns').textContent)||1;
  if(sig==='RISE')queueTrades('CALL',rfInst,tix,'t',null,runs);
  else if(sig==='FALL')queueTrades('PUT',rfInst,tix,'t',null,runs);
  else showTradeMsg('No signal - press ANALYSE first','#ff3b5c');
}

function tradeD(){
  const dir=document.getElementById('dDir').textContent;
  const ent=document.getElementById('dEnt').textContent;
  const runs=parseInt(document.getElementById('dRns').textContent)||1;
  if(ent==='-'||dir==='WAIT'){showTradeMsg('No signal - press ANALYSE DIGITS first','#ff3b5c');return;}
  const barrier=parseInt(ent);
  // Always 1 tick for OVER/UNDER - each run is 1 independent contract
  if(dir==='OVER')queueTrades('DIGITOVER',dInst,1,'t',barrier,runs);
  else if(dir==='UNDER')queueTrades('DIGITUNDER',dInst,1,'t',barrier,runs);
  else showTradeMsg('No signal','#ff3b5c');
}

function tradeDM(){
  const type=document.getElementById('dmDir').textContent;
  const dig=document.getElementById('dmDig').textContent;
  const runs=parseInt(document.getElementById('dmRns').textContent)||1;
  if(dig==='-'||type==='WAIT'){showTradeMsg('No signal - press ANALYSE first','#ff3b5c');return;}
  const barrier=parseInt(dig);
  if(type==='DIFFERS')queueTrades('DIGITDIFF',dmInst,1,'t',barrier,runs);
  else if(type==='MATCHES')queueTrades('DIGITMATCH',dmInst,1,'t',barrier,runs);
  else showTradeMsg('No signal','#ff3b5c');
}

// Scanner - ONE trade, best signal only
function scanTrade(dir,inst,barrier,runs){
  if(!apiToken){showTradeMsg('Enter API token first','#ff3b5c');return;}
  // Scanner has its OWN fire path - independent of bot
  if(botRunning){showTradeMsg('[!] Bot is running - stop bot to use scanner','#ff8c00');return;}
  let ct;
  if(dir==='OVER')ct='DIGITOVER';
  else if(dir==='UNDER')ct='DIGITUNDER';
  else if(dir==='DIFFERS')ct='DIGITDIFF';
  else if(dir==='MATCHES')ct='DIGITMATCH';
  else if(dir==='EVEN')ct='DIGITEVEN';
  else if(dir==='ODD')ct='DIGITODD';
  else if(dir==='RISE')ct='CALL';
  else if(dir==='FALL')ct='PUT';
  else{showTradeMsg('No valid signal','#ff3b5c');return;}
  const b=(barrier!==null&&barrier!==undefined&&barrier!=='null')?parseInt(barrier):null;
  queueTrades(ct,inst,1,'t',b,1); // scanner always 1 run
}

// ── ACCOUNT UI ──
function showAccountInfo(auth){
  document.getElementById('tradeLogin').style.display='none';
  document.getElementById('tradeAccount').style.display='block';
  document.getElementById('accName').textContent=auth.fullname||auth.loginid||'Account';
  document.getElementById('accId').textContent=auth.loginid||'';
  document.getElementById('accBal').textContent=parseFloat(auth.balance||0).toFixed(2)+' '+(auth.currency||'USD');
  document.getElementById('accType').textContent=auth.is_virtual?'DEMO':'REAL';
  document.getElementById('accType').style.color=auth.is_virtual?'#ffd700':'#00ff88';
  document.querySelectorAll('.trade-btn-wrap').forEach(w=>w.style.display='flex');
  document.querySelectorAll('.scan-trade-btn').forEach(b=>b.style.display='block');
  showTradeMsg('[OK] Account connected - ready to trade','#00ff88');
}

function refreshPositions(){
  try{
    const wrap=document.getElementById('openPositions');
    const ids=Object.keys(openContracts);
    if(!ids.length){wrap.innerHTML='<span style="font-family:var(--mn);font-size:9px;color:var(--dm)">No open positions</span>';return;}
    wrap.innerHTML=ids.map(id=>{
      const c=openContracts[id];
      const pnl=c.profit!==undefined?+(+c.profit).toFixed(2):null;
      const col=pnl===null?'var(--dm)':pnl>=0?'#00ff88':'#ff3b5c';
      const b=c.barrier!==undefined&&c.barrier!==null?' digit '+c.barrier:'';
      return`<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(28,50,72,.3);font-family:var(--mn);font-size:9px;">
        <span style="color:var(--tx)">${c.contract_type||'-'}${b}</span>
        <span style="color:var(--dm)">${SYM[c.underlying]||c.underlying||''}</span>
        <span style="color:#00d4ff">$${c.buy_price||'-'}</span>
        ${pnl!==null?`<span style="color:${col}">${pnl>=0?'+':''}${pnl}</span>`:'<span style="color:var(--dm)">open</span>'}
      </div>`;
    }).join('');
    // Show run queue status
    if(runQueue.length>0){
      wrap.innerHTML+=`<div style="font-family:var(--mn);font-size:9px;color:#ffd700;padding:4px 0">[~] ${runQueue.length} run${runQueue.length>1?'s':''} queued...</div>`;
    }
  }catch(e){}
}

function setLoggedOut(){
  apiToken=null;accountInfo=null;tradeWSok=false;tradeReady=false;
  runQueue=[];runExecuting=false;
  document.getElementById('tradeLogin').style.display='block';
  document.getElementById('tradeAccount').style.display='none';
  document.querySelectorAll('.trade-btn-wrap').forEach(w=>w.style.display='none');
  document.querySelectorAll('.scan-trade-btn').forEach(b=>b.style.display='none');
  try{document.getElementById('apiTokenInput').value='';}catch(e){}
}

function doLogin(){
  const tok=document.getElementById('apiTokenInput').value.trim();
  if(!tok||tok.length<8){showTradeMsg('Enter a valid API token','#ff3b5c');return;}
  apiToken=tok;
  showTradeMsg('[~] Connecting to your account...','#ffd700');
  // Disable login button during attempt
  const btn=document.getElementById('loginBtn');
  if(btn){btn.disabled=true;btn.style.opacity='.5';}
  initTradeWS(tok);
  // Timeout - if no response in 12s, show clear error
  setTimeout(()=>{
    const b=document.getElementById('loginBtn');
    if(b){b.disabled=false;b.style.opacity='1';}
    if(!accountInfo&&apiToken){
      showTradeMsg('[ERR] Login failed - create a new token at app.deriv.com/account/api-token with Read+Trade scopes','#ff3b5c');
      apiToken=null; // reset so user can try again cleanly
    }
  },12000);
}

function doLogout(){
  clearInterval(pingTimer);
  if(tradeWS)try{tradeWS.close();}catch(e){}
  setLoggedOut();
  showTradeMsg('Logged out','#ffd700');
}

function showTradeMsg(msg,col){
  try{
    const el=document.getElementById('tradeMsg');
    el.textContent=msg;el.style.color=col||'#00d4ff';el.style.display='block';
    clearTimeout(el._t);
    if(col!=='#00ff88'||!msg.includes('connected'))
      el._t=setTimeout(()=>{el.style.display='none';},8000);
  }catch(e){}
}

// ── INJECT TRADE UI ──
function injectTradingUI(){
  const panel=document.createElement('div');
  panel.id='tradePanel';
  panel.innerHTML=`
  <div style="background:linear-gradient(135deg,rgba(0,212,255,.07),rgba(0,255,136,.04));border-bottom:2px solid var(--bd);padding:12px 14px;position:relative;z-index:1;">
    <div style="font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:3px;color:#00d4ff;margin-bottom:10px;">[!] TRADING ACCOUNT</div>
    <div id="tradeLogin">
      <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:7px;line-height:1.7">Enter Deriv API token (Read+Trade). Stays in your browser - never shared.</div>
      <div style="display:flex;gap:7px;">
        <input id="apiTokenInput" type="password" placeholder="Paste API token here"
          style="flex:1;background:var(--p2);border:1.5px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:10px;padding:8px 10px;border-radius:5px;outline:none;"
          onkeydown="if(event.key==='Enter')doLogin()">
        <button id="loginBtn" onclick="doLogin()" style="padding:8px 18px;background:rgba(0,212,255,.12);border:2px solid #00d4ff;color:#00d4ff;font-family:var(--dp);font-size:14px;font-weight:700;letter-spacing:2px;border-radius:5px;cursor:pointer;">LOGIN</button>
      </div>
      <div style="font-family:var(--mn);font-size:8px;color:var(--dm);margin-top:5px;">Get token: app.deriv.com/account/api-token · Select Read + Trade only</div>
    </div>
    <div id="tradeAccount" style="display:none">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:10px;">
        <div style="background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);border-radius:6px;padding:8px 14px;min-width:140px;">
          <div style="font-family:var(--mn);font-size:8px;color:var(--dm)">BALANCE</div>
          <div style="font-family:var(--dp);font-size:26px;font-weight:900;color:#00ff88" id="accBal">-</div>
          <div style="font-family:var(--dp);font-size:11px;font-weight:700;letter-spacing:2px;margin-top:1px" id="accType">-</div>
        </div>
        <div style="flex:1;min-width:130px;">
          <div style="font-family:var(--dp);font-size:16px;font-weight:700;color:var(--tx)" id="accName">-</div>
          <div style="font-family:var(--mn);font-size:9px;color:var(--dm);margin-bottom:6px" id="accId">-</div>
          <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
            <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">BASE $</span>
            <input id="stakeAmt" type="number" value="1" min="0.35" step="0.5"
              style="width:60px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:11px;padding:5px 7px;border-radius:5px;text-align:center;"
              onchange="MG.base=parseFloat(this.value)||1;MG.current=MG.base;updMartStats();">
            <span style="font-family:var(--mn);font-size:9px;color:var(--dm)">MAX $</span>
            <input id="maxStake" type="number" value="50" min="1"
              style="width:60px;background:var(--p2);border:1px solid var(--bd);color:var(--tx);font-family:var(--mn);font-size:11px;padding:5px 7px;border-radius:5px;text-align:center;">
            <button onclick="doLogout()" style="padding:5px 10px;background:rgba(255,59,92,.08);border:1px solid rgba(255,59,92,.3);color:#ff3b5c;font-family:var(--mn);font-size:9px;border-radius:4px;cursor:pointer;">LOGOUT</button>
          </div>
        </div>
      </div>
      <!-- MARTINGALE TRACKER -->
      <div id="mgTrackerPanel" style="background:rgba(0,0,0,.2);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;margin-bottom:8px;">
        <div style="font-family:var(--dp);font-size:9px;font-weight:700;letter-spacing:2px;color:var(--dm);margin-bottom:6px;">MG · OV0-3/RF×3.6 · DIFF×6.8 · OV4/U5×2.1 · MATCH×1.5 · E/O×2.1</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="text-align:center"><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">NEXT STAKE</div><div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#ffd700" id="mgStake">$1.00</div></div>
          <div style="text-align:center"><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">P&amp;L</div><div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#00ff88" id="mgPnl">+$0</div></div>
          <div style="text-align:center"><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">WINS</div><div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#00ff88" id="mgW">0</div></div>
          <div style="text-align:center"><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">LOSSES</div><div style="font-family:var(--dp);font-size:22px;font-weight:900;color:#ff3b5c" id="mgL">0</div></div>
          <div style="text-align:center"><div style="font-family:var(--mn);font-size:8px;color:var(--dm)">STREAK</div><div style="font-family:var(--dp);font-size:22px;font-weight:900" id="mgS">0L</div></div>
          <button onclick="runQueue=[];runExecuting=false;MG.current=MG.base;document.getElementById('stakeAmt').value=MG.base;updMartStats();showTradeMsg('Reset','#ffd700');" style="padding:5px 10px;background:rgba(255,215,0,.08);border:1px solid rgba(255,215,0,.3);color:#ffd700;font-family:var(--mn);font-size:9px;border-radius:4px;cursor:pointer;">RESET</button>
        </div>
      </div>
      <!-- OPEN POSITIONS -->
      <div id="openPosPanel" style="background:rgba(0,0,0,.15);border:1px solid var(--bd);border-radius:6px;padding:8px 10px;">
        <div style="font-family:var(--dp);font-size:10px;font-weight:700;letter-spacing:2px;color:var(--dm);margin-bottom:4px;">OPEN POSITIONS</div>
        <div id="openPositions"><span style="font-family:var(--mn);font-size:9px;color:var(--dm)">No open positions</span></div>
      </div>
    </div>
    <div id="tradeMsg" style="display:none;font-family:var(--mn);font-size:10px;margin-top:8px;padding:6px 10px;background:rgba(0,0,0,.25);border-radius:4px;letter-spacing:.5px;"></div>
  </div>`;
  const banner=document.getElementById('banner');
  banner.parentNode.insertBefore(panel,banner.nextSibling);

  // RF trade button
  const rfB=document.createElement('div');
  rfB.className='trade-btn-wrap';rfB.style.cssText='display:none;margin-top:8px;';
  rfB.innerHTML=`<button onclick="tradeRF()" style="width:100%;padding:13px;background:rgba(0,255,136,.1);border:2px solid #00ff88;color:#00ff88;font-family:var(--dp);font-size:16px;font-weight:900;letter-spacing:3px;border-radius:6px;cursor:pointer;" onmousedown="this.style.background='rgba(0,255,136,.22)'" onmouseup="this.style.background='rgba(0,255,136,.1)'">[!] PLACE HIGHER/LOWER · ALL RUNS</button>`;
  document.getElementById('rfCard').appendChild(rfB);

  // Digits trade button
  const dB=document.createElement('div');
  dB.className='trade-btn-wrap';dB.style.cssText='display:none;margin-bottom:12px;';
  dB.innerHTML=`<button onclick="tradeD()" style="width:100%;padding:13px;background:rgba(0,255,136,.1);border:2px solid #00ff88;color:#00ff88;font-family:var(--dp);font-size:16px;font-weight:900;letter-spacing:3px;border-radius:6px;cursor:pointer;" onmousedown="this.style.background='rgba(0,255,136,.22)'" onmouseup="this.style.background='rgba(0,255,136,.1)'">[!] PLACE OVER/UNDER · ALL RUNS</button>`;
  document.getElementById('dBtn').insertAdjacentElement('afterend',dB);

  // DM trade button
  const dmB=document.createElement('div');
  dmB.className='trade-btn-wrap';dmB.style.cssText='display:none;margin-bottom:12px;';
  dmB.innerHTML=`<button onclick="tradeDM()" style="width:100%;padding:13px;background:rgba(179,136,255,.1);border:2px solid #b388ff;color:#b388ff;font-family:var(--dp);font-size:16px;font-weight:900;letter-spacing:3px;border-radius:6px;cursor:pointer;" onmousedown="this.style.background='rgba(179,136,255,.22)'" onmouseup="this.style.background='rgba(179,136,255,.1)'">[!] PLACE DIFFER/MATCH · ALL RUNS</button>`;
  document.getElementById('dmBtn').insertAdjacentElement('afterend',dmB);
}




// ── SMART BARRIER CALCULATOR ──
// Target: 30% payout on stake (sell_price = stake * 1.30)
// Volatility proxied from recent tick range
function calcBarrier(sym, dir){
  const prices=getPx(sym);
  if(!prices||prices.length<5)return dir==='HIGHER'?'+0.01':'-0.01';
  // Calculate recent volatility (std dev of last 20 ticks)
  const recent=prices.slice(-20);
  const mean=recent.reduce((a,b)=>a+b,0)/recent.length;
  const variance=recent.reduce((a,b)=>a+(b-mean)**2,0)/recent.length;
  const stdDev=Math.sqrt(variance);
  // For ~30% payout, barrier should be ~0.3-0.5 std devs from current price
  // Tighter barrier = higher payout but lower win probability
  // 0.4 stdDev gives roughly 30-35% payout on most Deriv instruments
  const offset=+(stdDev*0.4).toFixed(sym.includes('HZ')||prices[0]<100?4:2);
  const minOffset=prices[prices.length-1]*0.0002; // min 0.02% of price
  const finalOffset=Math.max(offset,minOffset).toFixed(sym.includes('HZ')||prices[0]<100?4:2);
  return dir==='HIGHER'?`+${finalOffset}`:`-${finalOffset}`;
}
// ── SOUND ALERTS ──
let audioCtx=null;
function getAudioCtx(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function playTone(freq,duration,type='sine',vol=0.3){
  try{
    const ctx=getAudioCtx();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.connect(gain);gain.connect(ctx.destination);
    osc.type=type;osc.frequency.value=freq;
    gain.gain.setValueAtTime(vol,ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+duration);
    osc.start(ctx.currentTime);osc.stop(ctx.currentTime+duration);
  }catch(e){}
}
function soundWin(){
  // Two rising tones - pleasant win chime
  playTone(600,0.15,'sine',0.25);
  setTimeout(()=>playTone(900,0.25,'sine',0.25),160);
}
function soundLoss(){
  // Low descending tone
  playTone(300,0.2,'sine',0.2);
  setTimeout(()=>playTone(200,0.3,'sine',0.2),200);
}
function soundTP(){
  // Triumphant 3-tone chime
  playTone(600,0.12,'sine',0.3);
  setTimeout(()=>playTone(750,0.12,'sine',0.3),130);
  setTimeout(()=>playTone(900,0.3,'sine',0.3),260);
}
function soundSL(){
  // 3 descending alert tones
  playTone(400,0.15,'sawtooth',0.2);
  setTimeout(()=>playTone(300,0.15,'sawtooth',0.2),170);
  setTimeout(()=>playTone(200,0.3,'sawtooth',0.2),340);
}
function soundTrade(){
  // Quick click on trade fire
  playTone(800,0.05,'square',0.1);
}

// ── TRADE HISTORY ──
const tradeHistory=[];

function addTradeHistory(ct,symbol,barrier,stake,pnl,won){
  const entry={
    time:new Date().toISOString(),
    timeStr:new Date().toTimeString().slice(0,8),
    ct,symbol:SYM[symbol]||symbol,barrier,stake,pnl,won,
    balance:accountInfo?parseFloat(accountInfo.balance||0):0
  };
  tradeHistory.unshift(entry);
  if(tradeHistory.length>200)tradeHistory.pop();
  renderTradeHistory();
}

function renderTradeHistory(){
  try{
    const tb=document.getElementById('tradeHistTbl');
    if(!tb)return;
    const typeLabel=ct=>{
      if(!ct||ct==='UNKNOWN')return'-';
      const map={DIGITOVER:'OVER',DIGITUNDER:'UNDER',DIGITDIFF:'DIFFERS',
                 DIGITMATCH:'MATCH',DIGITEVEN:'EVEN',DIGITODD:'ODD',
                 CALL:'HIGHER',PUT:'LOWER'};
      return map[ct]||ct.replace('DIGIT','');
    };
    tb.innerHTML=tradeHistory.slice(0,50).map(e=>`
      <tr style="border-bottom:1px solid rgba(28,50,72,.3)">
        <td style="color:var(--dm);font-size:9px">${e.timeStr}</td>
        <td style="color:#00d4ff;font-weight:700">${typeLabel(e.ct)}</td>
        <td style="color:var(--tx)">${e.symbol||'-'}</td>
        <td style="color:#ffd700">${e.barrier!==null&&e.barrier!==undefined?e.barrier:'-'}</td>
        <td style="color:#ffd700">$${parseFloat(e.stake||0).toFixed(2)}</td>
        <td style="color:${e.won?'#00ff88':'#ff3b5c'}">${e.won?'+':''}$${e.pnl.toFixed(2)}</td>
        <td style="color:${e.won?'#00ff88':'#ff3b5c'};font-weight:700">${e.won?'WIN':'LOSS'}</td>
      </tr>`).join('');
    // Update summary
    const wins=tradeHistory.filter(e=>e.won).length;
    const total=tradeHistory.length;
    const totalPnl=tradeHistory.reduce((s,e)=>s+e.pnl,0);
    const wr=total?Math.round(wins/total*100):0;
    try{
      document.getElementById('histWR').textContent=wr+'%';
      document.getElementById('histWR').style.color=wr>=55?'#00ff88':wr>=45?'#ffd700':'#ff3b5c';
      document.getElementById('histTotal').textContent=total;
      document.getElementById('histPnl').textContent=(totalPnl>=0?'+$':'-$')+Math.abs(totalPnl).toFixed(2);
      document.getElementById('histPnl').style.color=totalPnl>=0?'#00ff88':'#ff3b5c';
    }catch(e){}
  }catch(e){}
}

function exportCSV(){
  if(!tradeHistory.length){showTradeMsg('No trades to export','#ff3b5c');return;}
  const hdr='Time,Type,Symbol,Barrier,Stake,P&L,Result\n';
  const rows=tradeHistory.map(e=>`${e.time},${e.ct},${e.symbol},${e.barrier??''},${e.stake},${e.pnl.toFixed(2)},${e.won?'WIN':'LOSS'}`).join('\n');
  const blob=new Blob([hdr+rows],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`DerivSignal_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showTradeMsg(`[OK] Exported ${tradeHistory.length} trades`,'#00ff88');
}

let botRunning=false,botTimer=null;
let botPnl=0,botWins=0,botLosses=0,botStake=1;
let botActive=false,botPipeline=0;
let botNextSignal=null;
let botPreloading=false;
let botLastFireTime=0;
let botCurrentContractId=null; // tracks the ONE open bot contract
let botRecoveryMode=false;
let botBaseStake=1;
// Bot isolated history - completely separate from manual
const botHistory=[];
let botHistoryIdCounter=0;

// ── BOT MODE UI CONTROL ──
function freezeTopPanel(){
  try{
    const mg=document.getElementById('mgTrackerPanel');
    const op=document.getElementById('openPosPanel');
    if(mg){
      mg.style.opacity='0.35';
      mg.style.pointerEvents='none';
      // Insert BOT MODE banner
      if(!document.getElementById('botModeBanner')){
        const banner=document.createElement('div');
        banner.id='botModeBanner';
        banner.style.cssText='position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);border-radius:6px;z-index:10;';
        banner.innerHTML='<span style="font-family:var(--dp);font-size:13px;font-weight:900;color:#ffd700;letter-spacing:3px;">[!] BOT RUNNING</span>';
        mg.style.position='relative';
        mg.appendChild(banner);
      }
    }
    if(op){
      op.style.opacity='0.35';
      op.style.pointerEvents='none';
    }
  }catch(e){}
}

function unfreezeTopPanel(){
  try{
    const mg=document.getElementById('mgTrackerPanel');
    const op=document.getElementById('openPosPanel');
    if(mg){
      mg.style.opacity='1';
      mg.style.pointerEvents='auto';
      const b=document.getElementById('botModeBanner');
      if(b)b.remove();
    }
    if(op){
      op.style.opacity='1';
      op.style.pointerEvents='auto';
    }
  }catch(e){}
}

// Bot isolated history functions
function addBotHistory(entry){
  botHistory.unshift(entry);
  if(botHistory.length>200)botHistory.pop();
  renderBotHistory();
}

function renderBotHistory(){
  try{
    const tb=document.getElementById('botHistTbl');
    if(!tb)return;
    if(!botHistory.length){
      tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--dm);padding:16px">No bot trades yet</td></tr>';
      return;
    }
    tb.innerHTML=botHistory.slice(0,100).map(e=>{
      const typeLabel={DIGITOVER:'OVER',DIGITUNDER:'UNDER',DIGITDIFF:'DIFFERS',
        DIGITMATCH:'MATCH',DIGITEVEN:'EVEN',DIGITODD:'ODD',CALL:'HIGHER',PUT:'LOWER'};
      const tl=typeLabel[e.ct]||e.ct||'-';
      const col=e.won?'#00ff88':'#ff3b5c';
      const mode=e.recovery?'[REC]':'[NRM]';
      return`<tr style="border-bottom:1px solid rgba(28,50,72,.3)">
        <td style="color:var(--dm);font-size:9px;white-space:nowrap">${e.timeStr}</td>
        <td style="color:#ffd700;font-size:8px">${mode}${e.recovery?'REC':'NRM'}</td>
        <td style="color:#00d4ff;font-weight:700">${tl} ${e.barrier!==null&&e.barrier!==undefined?e.barrier:''}</td>
        <td style="color:var(--tx)">${e.sym}</td>
        <td style="color:#ffd700">$${parseFloat(e.stake).toFixed(2)}</td>
        <td style="color:${col};font-weight:700">${e.won?'+':''}$${parseFloat(e.pnl).toFixed(2)}</td>
        <td style="color:${col};font-weight:700">${e.won?'WIN':'LOSS'}</td>
        <td style="color:var(--dm);font-size:8px;max-width:80px;overflow:hidden;text-overflow:ellipsis">${e.contractId||'-'}</td>
      </tr>`;
    }).join('');
    // Update summary
    const wins=botHistory.filter(e=>e.won).length;
    const wr=botHistory.length?Math.round(wins/botHistory.length*100):0;
    const pnl=botHistory.reduce((s,e)=>s+e.pnl,0);
    try{
      document.getElementById('botHistWR').textContent=wr+'%';
      document.getElementById('botHistWR').style.color=wr>=60?'#00ff88':wr>=50?'#ffd700':'#ff3b5c';
      document.getElementById('botHistTotal').textContent=botHistory.length;
      document.getElementById('botHistPnl').textContent=(pnl>=0?'+$':'-$')+Math.abs(pnl).toFixed(2);
      document.getElementById('botHistPnl').style.color=pnl>=0?'#00ff88':'#ff3b5c';
    }catch(e){}
  }catch(e){}
}

function exportBotCSV(){
  if(!botHistory.length){showTradeMsg('No bot trades to export','#ff3b5c');return;}
  const hdr='Time,Mode,Type,Symbol,Barrier,Stake,PnL,Result,ContractID\n';
  const rows=botHistory.map(e=>`${e.time},${e.recovery?'RECOVERY':'NORMAL'},${e.ct},${e.sym},${e.barrier??''},${e.stake},${e.pnl.toFixed(2)},${e.won?'WIN':'LOSS'},${e.contractId||''}`).join('\n');
  const blob=new Blob([hdr+rows],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`BotHistory_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showTradeMsg(`[OK] Exported ${botHistory.length} bot trades`,'#00ff88');
}

// ── EVEN/ODD ──
let eoInst='R_75',eoMaxR=0,eoRDone=0,eoETi=null;

function selEO(el,s){
  document.querySelectorAll('#tab-eo .ib').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');eoInst=s;
  document.getElementById('eoLbl').textContent=SYM[s];
  document.getElementById('eoLiveBadge').innerHTML=hd[s]?'<span class="livebadge">LIVE</span>':'<span class="simbadge">SIM</span>';
  seedStream('eorow',getDg(s).map(d=>d)); // reuse srow logic
  updEOFreq(getDg(s));
  subInst(s);
}

function addEOStream(d){
  try{
    const row=document.getElementById('eorow');
    const el=document.createElement('div');
    el.className='sd new';
    el.style.background=d%2===0?'rgba(0,212,255,.15)':'rgba(179,136,255,.15)';
    el.style.border=`1px solid ${d%2===0?'rgba(0,212,255,.4)':'rgba(179,136,255,.4)'}`;
    el.style.color=d%2===0?'#00d4ff':'#b388ff';
    el.textContent=d;
    row.appendChild(el);
    while(row.children.length>35)row.removeChild(row.firstChild);
    row.parentElement.scrollLeft=row.parentElement.scrollWidth;
  }catch(e){}
}

function updEOFreq(stream){
  try{
    if(!stream||!stream.length)return;
    const total=stream.length;
    const evenC=stream.filter(d=>d%2===0).length;
    const ep=Math.round(evenC/total*100),op=100-ep;
    document.getElementById('eoEvenPct').textContent=ep+'%';
    document.getElementById('eoOddPct').textContent=op+'%';
    document.getElementById('eoEvenBar').style.width=ep+'%';
    document.getElementById('eoOddBar').style.width=op+'%';
    const last10=stream.slice(-10);
    document.getElementById('eoLast10').textContent=last10.map(d=>d%2===0?'E':'O').join(' ');
    const lastD=stream[stream.length-1];
    let streak=0;
    for(let i=stream.length-1;i>=0;i--){if((stream[i]%2===0)===(lastD%2===0))streak++;else break;}
    document.getElementById('eoStreakTxt').textContent=streak+'× '+(lastD%2===0?'EVEN':'ODD');
  }catch(e){}
}

function analyseEO(stream,inst){
  if(!stream||stream.length<10)return{dir:'WAIT',conf:0,runs:0,cond:'Need more ticks...',evenPct:50,oddPct:50,streak:0};
  const total=stream.length,evenC=stream.filter(d=>d%2===0).length;
  const ep=evenC/total*100,op=100-ep,dev=ep-50;
  const lastD=stream[stream.length-1];
  let streak=0;
  for(let i=stream.length-1;i>=0;i--){if((stream[i]%2===0)===(lastD%2===0))streak++;else break;}
  const lastType=lastD%2===0?'EVEN':'ODD';
  const s1=is1s(inst);
  let dir,conf,cond;
  if(streak>=6){dir=lastType==='EVEN'?'ODD':'EVEN';conf=Math.min(68,50+streak*3);cond=`${streak}× ${lastType} streak - break to ${dir} likely.`;}
  else if(Math.abs(dev)>=10){dir=dev>0?'ODD':'EVEN';conf=Math.min(70,50+Math.abs(dev)*1.2);cond=`${Math.round(ep)}% Even / ${Math.round(op)}% Odd - ${dir} reversion favoured.`;}
  else if(streak>=4){dir=lastType==='EVEN'?'ODD':'EVEN';conf=Math.min(62,48+streak*2);cond=`${streak}× ${lastType} - ${dir} signal forming.`;}
  else{dir='WAIT';conf=0;cond=`Balanced ${Math.round(ep)}% Even / ${Math.round(op)}% Odd - no signal yet.`;}
  const runs=dir==='WAIT'?0:conf>=62?(s1?3:4):conf>=55?(s1?2:3):(s1?1:2);
  return{dir,conf:Math.round(conf),runs,cond,evenPct:Math.round(ep),oddPct:Math.round(op),streak};
}

function runEO(){
  const btn=document.getElementById('eoBtn'),scn=document.getElementById('eoScan');
  btn.disabled=true;btn.style.opacity='.35';scn.style.display='block';
  setTimeout(()=>{
    try{
      const stream=getDg(eoInst);updEOFreq(stream);
      const r=analyseEO(stream,eoInst);
      const isEven=r.dir==='EVEN',col=isEven?'#00d4ff':'#b388ff';
      document.getElementById('eoDir').textContent=r.dir;
      document.getElementById('eoDir').className=`dsv ${isEven?'a':r.dir==='ODD'?'pu':'y'}`;
      document.getElementById('eoDirCell').className=`dsc ${isEven?'a':r.dir==='ODD'?'pu':'y'}`;
      document.getElementById('eoRns').textContent=r.runs||'WAIT';
      document.getElementById('eoRns').style.color=r.runs>=3?'#00ff88':r.runs>=2?'#ffd700':'#ff8c00';
      document.getElementById('eoCond').textContent=r.cond;
      document.getElementById('eoCpct').textContent=r.conf+'%';
      const cf=document.getElementById('eoCf');cf.style.width=r.conf+'%';cf.style.background=r.dir!=='WAIT'?col:'#ff3b5c';
      eoMaxR=r.runs;eoRDone=0;
      if(r.runs>0){
        buildDots('eoDots',r.runs);
        document.getElementById('eoRW').style.display='block';
        document.getElementById('eoMb').disabled=false;document.getElementById('eoMb').style.opacity='1';
        document.getElementById('eoRN').textContent=`${r.runs} run${r.runs>1?'s':''} × 1 tick`;
        startExp('eo',Math.max(10,r.runs*(is1s(eoInst)?3:5)));
      } else {
        document.getElementById('eoRW').style.display='none';document.getElementById('eoEW').style.display='none';
        if(eoETi)clearInterval(eoETi);
      }
      addEOLog(r);
    }catch(e){}
    scn.style.display='none';btn.disabled=false;btn.style.opacity='1';
  },250);
}

function eoMark(){
  try{
    if(eoRDone>=eoMaxR)return;
    document.getElementById(`eoDots_${eoRDone}`)?.classList.add('on');
    eoRDone++;
    if(eoRDone>=eoMaxR){document.getElementById('eoMb').disabled=true;document.getElementById('eoMb').style.opacity='.3';if(eoETi)clearInterval(eoETi);document.getElementById('eoEf').style.width='0%';document.getElementById('eoEp').textContent='DONE';}
  }catch(e){}
}

function tradeEO(){
  const dir=document.getElementById('eoDir').textContent;
  const runs=parseInt(document.getElementById('eoRns').textContent)||1;
  if(dir==='WAIT'||dir==='-'){showTradeMsg('No signal - press ANALYSE EVEN/ODD first','#ff3b5c');return;}
  if(dir==='EVEN')queueTrades('DIGITEVEN',eoInst,1,'t',null,runs);
  else if(dir==='ODD')queueTrades('DIGITODD',eoInst,1,'t',null,runs);
}

function addEOLog(r){
  try{
    const tb=document.getElementById('eoLog');
    if(tb.querySelector('td[colspan]'))tb.innerHTML='';
    const col=r.dir==='EVEN'?'style="color:#00d4ff"':r.dir==='ODD'?'style="color:#b388ff"':'class="wt"';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${new Date().toTimeString().slice(0,8)}</td><td>${SYM[eoInst]}</td><td ${col}>${r.dir}</td><td style="color:#00d4ff">${r.evenPct}%</td><td style="color:#b388ff">${r.oddPct}%</td><td style="color:#ffd700">${r.runs}</td><td>${r.conf}%</td>`;
    tb.insertAdjacentElement('afterbegin',tr);
    if(tb.children.length>8)tb.removeChild(tb.lastChild);
  }catch(e){}
}



// ══════════════════════════════════════════════
// MULTI-BOT ENGINE: OVER/UNDER · EVEN/ODD · DIFFERS
// ══════════════════════════════════════════════
let activeBotType='ou'; // 'ou', 'eo', 'df'

// Bot configs
const BOT_CONFIGS={
  ou:{name:'OVER/UNDER',mg:3.6,findSignal:botFindOU,label:'#00ff88'},
  eo:{name:'EVEN/ODD',mg:2.1,findSignal:botFindEO,label:'#00d4ff'},
  df:{name:'DIFFERS',mg:6.8,findSignal:botFindDF,label:'#b388ff'}
};


function selBot(type){
  if(botRunning){showTradeMsg('Stop bot first','#ff3b5c');return;}
  activeBotType=type;
  const cols={ou:'#00ff88',eo:'#00d4ff',df:'#b388ff'};
  const col=cols[type];
  ['ou','eo','df'].forEach(t=>{
    const b=document.getElementById('botSel'+t.toUpperCase());
    if(!b)return;
    b.style.background=t===type?`rgba(${col==='#00ff88'?'0,255,136':col==='#00d4ff'?'0,212,255':'179,136,255'},.2)`:'rgba(128,128,128,.08)';
    b.style.borderColor=t===type?col:'rgba(128,128,128,.3)';
    b.style.color=t===type?col:'var(--dm)';
  });
  const mg=BOT_CONFIGS[type].mg;
  botLog(`Selected: ${BOT_CONFIGS[type].name} · MG×${mg}`,'#ffd700');
}

// Signal finders for each bot type
function botFindOU(){
  let best=null,bestConf=0;
  ALL.forEach(inst=>{
    const s=getDg(inst);if(!s||s.length<15)return;
    const r=analyseOD(s,inst);if(r.dir==='WAIT'||r.ent===null)return;
    // Normal mode: OVER 0-2 (strong deviation) or UNDER 7-9
    // Recovery mode: OVER 3-4 or UNDER 5-6 (slightly weaker but good)
    let ok=false;
    if(!botRecoveryMode){
      ok=(r.dir==='OVER'&&r.ent<=2)||(r.dir==='UNDER'&&r.ent>=7);
    } else {
      ok=(r.dir==='OVER'&&r.ent>=3&&r.ent<=4)||(r.dir==='UNDER'&&r.ent>=5&&r.ent<=6);
    }
    if(ok&&r.conf>bestConf){
      bestConf=r.conf;
      best={inst,dir:r.dir,ent:r.ent,conf:r.conf,ct:r.dir==='OVER'?'DIGITOVER':'DIGITUNDER'};
    }
  });
  return best;
}

// Called on every tick from the live stream
function botOnTick(){
  if(!botRunning||botActive||botCurrentContractId)return;
  if(runQueue.length>0){runQueue=[];}
  botTick();
}

function botFindEO(){
  let best=null,bestConf=0;
  ALL.forEach(inst=>{
    const s=getDg(inst);if(!s||s.length<15)return;
    const r=analyseEO(s,inst);if(r.dir==='WAIT')return;
    if(r.conf>bestConf){bestConf=r.conf;best={inst,dir:r.dir,ent:null,conf:r.conf,runs:Math.min(3,r.runs||1),ct:r.dir==='EVEN'?'DIGITEVEN':'DIGITODD'};}
  });
  return best;
}

function botFindDF(){
  let best=null,bestConf=0;
  ALL.forEach(inst=>{
    const s=getDg(inst);if(!s||s.length<15)return;
    const r=analyseDM(s,inst);if(r.type!=='DIFFERS')return;
    if(r.conf>bestConf){bestConf=r.conf;best={inst,dir:'DIFFERS',ent:r.digit,conf:r.conf,runs:Math.min(3,r.runs||1),ct:'DIGITDIFF'};}
  });
  return best;
}

// Pre-load next signal in background while trade is open
function botPreloadNext(){
  if(!botRunning||botPreloading)return;
  botPreloading=true;
  try{
    const cfg=BOT_CONFIGS[activeBotType];
    const sig=cfg.findSignal(); // respects botRecoveryMode automatically
    botNextSignal=sig||null;
    if(sig){
      const mode=botRecoveryMode?'[REC]':'[NRM]';
      botSetStatus(`${mode} Open · Next: ${sig.dir} ${sig.ent} · ${SYM[sig.inst]} · ${sig.conf}%`,'#ffd700');
    }
  }catch(e){botNextSignal=null;}
  botPreloading=false;
}

function botLog(msg,col){
  try{
    const el=document.getElementById('botActivity');
    if(!el)return;
    const t=new Date().toTimeString().slice(0,8);
    const line=document.createElement('div');
    line.style.cssText=`color:${col||'var(--dm)'};border-bottom:1px solid rgba(28,50,72,.3);padding:2px 0;`;
    line.textContent=`${t} ${msg}`;
    el.insertAdjacentElement('afterbegin',line);
    while(el.children.length>40)el.removeChild(el.lastChild);
  }catch(e){}
}

function botUpdStats(){
  try{
    const pnl=botPnl;
    document.getElementById('botPnl').textContent=(pnl>=0?'+$':'-$')+Math.abs(pnl).toFixed(2);
    document.getElementById('botPnl').style.color=pnl>=0?'#00ff88':'#ff3b5c';
    document.getElementById('botWins').textContent=botWins;
    document.getElementById('botLosses').textContent=botLosses;
    document.getElementById('botNextStake').textContent='$'+botStake.toFixed(2);
  }catch(e){}
}

function botSetStatus(msg,col){
  try{const el=document.getElementById('botStatus');if(el){el.textContent=msg;el.style.color=col||'var(--dm)';}}catch(e){}
}

function checkBotResult(d){
  if(!botRunning||!botActive)return;
  if(d&&d.msg_type==='proposal_open_contract'&&d.proposal_open_contract){
    const c=d.proposal_open_contract;
    if(c.is_sold){
      botPipeline=Math.max(0,botPipeline-1);
      const pnl=+(parseFloat(c.sell_price)-parseFloat(c.buy_price)).toFixed(2);
      const won=pnl>=0;
      botPnl=+(botPnl+pnl).toFixed(2);
      const cfg=BOT_CONFIGS[activeBotType];

      const capturedContractId=botCurrentContractId;
      // Clear lock FIRST
      botCurrentContractId=null;
      botActive=false;botPipeline=0;

      const maxS=parseFloat(document.getElementById('botMaxStake').value)||30;

      if(won){
        botWins++;
        if(botRecoveryMode){
          botRecoveryMode=false;
          try{document.getElementById('botModeLabel').textContent='[NRM] NORMAL · OVER2/UNDER7';document.getElementById('botModeLabel').style.color='#00ff88';}catch(e){}
          botLog(`[OK] RECOVERY WIN +$${pnl.toFixed(2)} → OVER2/UNDER7 · reset $${botBaseStake}`,'#00ff88');
        } else {
          botLog(`[OK] WIN +$${pnl.toFixed(2)}`,'#00ff88');
        }
        botStake=botBaseStake;
        try{soundWin();}catch(e){}
      } else {
        botLosses++;
        const next=+(botStake*3.6).toFixed(2);
        const newStake=next>maxS?botBaseStake:next;
        if(!botRecoveryMode){
          botRecoveryMode=true;
          try{document.getElementById('botModeLabel').textContent='[REC] RECOVERY · OVER3/UNDER6';document.getElementById('botModeLabel').style.color='#ff3b5c';}catch(e){}
          botLog(`[X] LOSS -$${Math.abs(pnl).toFixed(2)} → RECOVERY: OVER3/UNDER6 · $${newStake}`,'#ff3b5c');
        } else {
          botLog(`[X] LOSS -$${Math.abs(pnl).toFixed(2)} → MG×3.6 → $${newStake}`,'#ff3b5c');
        }
        if(next>maxS){botRecoveryMode=false;botLog('[!] Max stake → reset','#ff8c00');}
        botStake=newStake;
        try{soundLoss();}catch(e){}
      }

      botPnl=+(botPnl+pnl).toFixed(2);

      // Log to BOT'S OWN ISOLATED HISTORY
      try{
        addBotHistory({
          time:new Date().toISOString(),
          timeStr:new Date().toTimeString().slice(0,8),
          ct:MG.lastType||'UNKNOWN',
          sym:SYM[MG.lastSym]||MG.lastSym||'-',
          barrier:MG.lastBarrier!==null&&MG.lastBarrier!==undefined?MG.lastBarrier:null,
          stake:MG.lastStake||botStake,
          pnl:pnl,
          won:won,
          recovery:won?false:botRecoveryMode,
          contractId:capturedContractId&&capturedContractId!=='pending'?capturedContractId:'-'
        });
      }catch(e){}

      botUpdStats();
      const modeStr=botRecoveryMode?'[REC] RECOVERY: OVER3/UNDER6':'[NRM] NORMAL: OVER2/UNDER7';
      botSetStatus(`${modeStr} · $${botStake.toFixed(2)} · scanning...`,'#00d4ff');

      // CHECK TP/SL
      const tp=parseFloat(document.getElementById('botTP').value)||20;
      const sl=parseFloat(document.getElementById('botSL').value)||15;
      if(botPnl>=tp){stopBot();botLog(`[TP] TP +$${tp} reached!`,'#00ff88');try{soundTP();}catch(e){}return;}
      if(botPnl<=-sl){stopBot();botLog(`[SL] SL -$${sl} hit!`,'#ff3b5c');try{soundSL();}catch(e){}return;}

      // NEXT SIGNAL — fire immediately, botActive lock prevents double-fire
      if(botNextSignal){
        const nextSig=botNextSignal;botNextSignal=null;
        botLog(`→ ${botRecoveryMode?'REC':'NRM'}: ${nextSig.dir} ${nextSig.ent!==null?nextSig.ent:''} · ${SYM[nextSig.inst]}`,'#00d4ff');
        botFire(nextSig); // instant — no timeout needed
      } else {
        const nextSig=BOT_CONFIGS[activeBotType].findSignal();
        if(nextSig){
          botFire(nextSig); // instant
        } else {
          const mode=botRecoveryMode?'OVER 3-4 / UNDER 5-6':'OVER 0-2 / UNDER 7-9';
          botSetStatus(`[>>] No signal · scanning ${mode}...`,'var(--dm)');
          // botOnTick will pick up on next tick
        }
      }
    }
  }
}

function botFire(sig){
  if(!accountInfo||!tradeWSok||!botRunning)return;
  // HARD SINGLE LOCK - one trade at a time
  if(botActive||botCurrentContractId){return;}
  botLastFireTime=Date.now();
  const stake=botStake;
  botActive=true;botPipeline=1;
  botCurrentContractId='pending'; // reserve slot BEFORE sending
  botNextSignal=null;
  const tickMs=getTickMs(sig.inst);
  botLog(`[!] ${sig.dir}${sig.ent!==null?' '+sig.ent:''} · ${SYM[sig.inst]} · $${stake} · ${sig.conf}%`,'#00d4ff');
  botSetStatus(`[~] Open: ${sig.dir}${sig.ent!==null?' '+sig.ent:''} · ${SYM[sig.inst]} · $${stake}`,'#ffd700');
  // Set MG tracking state BEFORE firing - so history captures correctly
  MG.lastType=sig.ct;
  MG.lastSym=sig.inst;
  MG.lastBarrier=sig.ent!==null&&sig.ent!==undefined?sig.ent:null;
  MG.lastStake=stake;
  MG.current=stake;

  // FIRE INSTANTLY
  const params={
    contract_type:sig.ct,symbol:sig.inst,
    duration:1,duration_unit:'t',
    basis:'stake',amount:stake,
    currency:accountInfo.currency||'USD'
  };
  if(sig.ent!==null&&sig.ent!==undefined)params.barrier=String(sig.ent);
  tradeSend({buy:'1',price:stake,parameters:params});
  try{soundTrade();}catch(e){}
  // START PRELOADING NEXT SIGNAL IMMEDIATELY while this trade is open
  // By the time result arrives, next signal is ready to fire instantly
  setTimeout(()=>botPreloadNext(), 200);
  // Timeout fallback
  setTimeout(()=>{
    if(botRunning&&botActive&&botPipeline>0){
      botActive=false;botPipeline=0;
      botNextSignal=null;
      botLog('[!] Timeout - rescanning','#ff8c00');
    }
  }, tickMs*3+500);
}

function botTick(){
  if(!botRunning)return;
  if(!accountInfo||!tradeWSok){botSetStatus('[~] Waiting for connection...','#ffd700');return;}
  if(botActive)return; // trade in progress - preload handles next
  // Use preloaded signal if available
  const cfg=BOT_CONFIGS[activeBotType];
  if(botNextSignal){
    const sig=botNextSignal;botNextSignal=null;
    botFire(sig);
  } else {
    const sig=cfg.findSignal();
    if(!sig){
      botSetStatus(`[>>] Scanning ${cfg.name}... no signal`,'var(--dm)');
      // Keep preloading for next tick
      setTimeout(()=>botPreloadNext(),500);
      return;
    }
    botFire(sig);
  }
}

function startBot(){
  if(!apiToken){showTradeMsg('Login with API token first','#ff3b5c');return;}
  if(!accountInfo){showTradeMsg('Wait for account to connect','#ffd700');return;}
  botRunning=true;botActive=false;botPipeline=0;
  botPnl=0;botWins=0;botLosses=0;
  botBaseStake=parseFloat(document.getElementById('botBase').value)||1;
  botStake=botBaseStake;
  botRecoveryMode=false;botNextSignal=null;botPreloading=false;
  botCurrentContractId=null;
  // Sync main MG base to bot base so martingale tracker matches
  MG.base=botBaseStake;
  MG.current=botBaseStake;
  MG.wins=0;MG.losses=0;MG.streak=0;MG.totalPnl=0;
  try{
    document.getElementById('stakeAmt').value=botBaseStake.toFixed(2);
    updMartStats();
  }catch(e){}
  document.getElementById('botStartBtn').style.display='none';
  document.getElementById('botStopBtn').style.display='block';
  freezeTopPanel();
  const cfg=BOT_CONFIGS[activeBotType];
  const tp=document.getElementById('botTP').value;
  const sl=document.getElementById('botSL').value;
  const modeInfo=activeBotType==='ou'?'Normal: OVER2/UNDER7 · Recovery: OVER3/UNDER6 ×3.2':
    `MG×${cfg.mg}`;
  botLog(`[START] ${cfg.name} · TP $${tp} · SL $${sl} · Base $${botStake} · ${modeInfo}`,'#ffd700');
  botSetStatus(`[!] TICK-SPEED · ${cfg.name} · scanning...`,'#00d4ff');
  botUpdStats();
  // Tick-speed: hook into live stream, no timer needed
  botTick();
  // Fallback timer in case tick stream stalls
  botTimer=setInterval(()=>{
    if(botRunning&&!botActive)botTick();
  },3000);
}

function stopBot(){
  botRunning=false;botActive=false;botPipeline=0;
  botCurrentContractId=null;
  clearInterval(botTimer);
  document.getElementById('botStartBtn').style.display='block';
  document.getElementById('botStopBtn').style.display='none';
  unfreezeTopPanel();
  const sign=botPnl>=0?'+':'';
  botSetStatus(`Stopped · P&L: ${sign}$${Math.abs(botPnl).toFixed(2)} · W:${botWins} L:${botLosses}`,'var(--dm)');
  botLog(`■ Stopped · P&L: ${sign}$${Math.abs(botPnl).toFixed(2)} · W:${botWins} L:${botLosses}`,'#ffd700');
  botUpdStats();
}

// Auto-scan every 30s
setInterval(()=>{try{if(document.getElementById('tab-sc').classList.contains('on'))runScan();}catch(e){}},30000);



// Init
try{initWS();}catch(e){setConn('offline');}
setTimeout(()=>{try{drawChart(getPx(rfInst));}catch(e){}},100);
injectTradingUI();
</script>

</body>
</html>
